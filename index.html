<!DOCTYPE html>
<html lang="zh" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Studio Pro - å®Œæ•´åŠŸèƒ½ç‰ˆ</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        html, body {
            height: 100%;
            font-family: "Inter", sans-serif;
            background: #0a0a0f;
            color: #e5e7eb;
        }
        
        .hero-bg {
            position: fixed;
            top: -300px;
            left: 50%;
            width: 1000px;
            height: 1000px;
            transform: translateX(-50%);
            background: radial-gradient(ellipse at center, #dc262644 0%, #ef444444 30%, #06b6d400 70%);
            filter: blur(140px);
            pointer-events: none;
            z-index: 0;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.25rem;
            overflow: hidden;
            backdrop-filter: blur(12px);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            transition: all 0.3s ease;
        }
        
        .btn-gradient:hover {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            transform: translateY(-1px);
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
        }
        
        .tab-active {
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 2px solid #dc2626;
        }
        
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
    </style>
</head>
<body class="relative">
    <!-- Background -->
    <div class="hero-bg"></div>
    
    <!-- Main Container -->
    <div class="relative z-10 h-full flex flex-col">
        <!-- Header -->
        <header class="border-b border-white/10 bg-black/20 backdrop-blur-xl">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center">
                            <i data-lucide="play" class="w-5 h-5 text-white"></i>
            </div>
                        <div>
                            <h1 class="text-xl font-bold">YouTube Studio Pro</h1>
                            <p class="text-xs text-white/60">å®Œæ•´åŠŸèƒ½ç‰ˆ v2.0</p>
            </div>
            </div>
                    
                    <div class="flex items-center gap-4">
                        <!-- API Status -->
                        <div id="apiStatus" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5">
                            <div id="apiIndicator" class="w-2 h-2 rounded-full bg-yellow-500"></div>
                            <span class="text-xs">APIæœªé…ç½®</span>
            </div>
                        
                        <!-- Help Button -->
                        <button onclick="showQuickHelp()" class="p-2 hover:bg-white/10 rounded-lg transition-all" title="å¿«é€Ÿå¸®åŠ©">
                            <i data-lucide="help-circle" class="w-5 h-5"></i>
                        </button>
                        
                        <!-- Settings Button -->
                        <button onclick="showSettings()" class="p-2 hover:bg-white/10 rounded-lg transition-all" title="è®¾ç½®">
                            <i data-lucide="settings" class="w-5 h-5"></i>
                        </button>
            </div>
        </div>

                <!-- Tabs -->
                <div class="flex gap-1 mt-4 overflow-x-auto">
                    <button onclick="switchTab('search')" id="tab-search" class="tab px-4 py-2 rounded-t-lg text-sm font-medium hover:bg-white/5 transition-all tab-active">
                        æœç´¢è§†é¢‘
                    </button>



                    <button onclick="switchTab('history')" id="tab-history" class="tab px-4 py-2 rounded-t-lg text-sm font-medium hover:bg-white/5 transition-all">
                        å†å²è®°å½•
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto custom-scrollbar">
            <!-- Search Tab -->
            <div id="content-search" class="tab-content p-6">
                <div class="max-w-6xl mx-auto">
                    <!-- Search Controls -->
                    <div class="panel p-6 mb-6">
                        <div class="flex flex-col lg:flex-row gap-4 mb-4">
                            <div class="flex-1">
                                <input type="text" 
                                    id="searchInput"
                                    placeholder="æœç´¢å…³é”®è¯æˆ–ç²˜è´´YouTubeé“¾æ¥..." 
                                    class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                            </div>
                            <div class="flex gap-2">
                                <select id="maxResults" class="bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-sm">
                                    <option value="10">10ä¸ªç»“æœ</option>
                                    <option value="20">20ä¸ªç»“æœ</option>
                                    <option value="50" selected>50ä¸ªç»“æœ</option>
                                    <option value="100">100ä¸ªç»“æœ</option>
                        </select>
                                <button onclick="performSearch()" class="btn-gradient text-white rounded-lg px-6 py-3 font-medium flex items-center gap-2">
                                    <i data-lucide="search" class="w-4 h-4"></i>
                                    æœç´¢
                                </button>
                                <button onclick="showSettings()" class="px-4 py-3 bg-blue-500/20 hover:bg-blue-500/30 text-blue-300 rounded-lg text-sm transition-all flex items-center gap-2">
                                    <i data-lucide="help-circle" class="w-4 h-4"></i>
                                    
                                </button>
                            </div>
                    </div>
                    
                        <!-- æœç´¢ç­›é€‰é¡¹ -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-xs text-white/60 mb-2">æ’åºæ–¹å¼</label>
                                <select id="searchOrder" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm">
                                    <option value="relevance">ç›¸å…³åº¦</option>
                            <option value="date">å‘å¸ƒæ—¶é—´</option>
                            <option value="viewCount">è§‚çœ‹æ•°</option>
                            <option value="rating">è¯„åˆ†</option>
                                    <option value="title">æ ‡é¢˜</option>
                                    <option value="videoCount">è§†é¢‘æ•°é‡</option>
                                    <option value="relevance">ä¸Šä¼ æ—¶é—´</option>
                        </select>
                    </div>
                            <div>
                                <label class="block text-xs text-white/60 mb-2">è§†é¢‘ç±»å‹</label>
                                <select id="videoType" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm">
                                    <option value="any">ä»»ä½•ç±»å‹</option>
                                    <option value="movie">ç”µå½±</option>
                                    <option value="episode">å‰§é›†</option>
                                    <option value="channel">é¢‘é“</option>
                                    <option value="playlist">æ’­æ”¾åˆ—è¡¨</option>
                                </select>
                </div>
                            <div>
                                <label class="block text-xs text-white/60 mb-2">è§†é¢‘æ—¶é•¿</label>
                                <select id="videoDuration" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm">
                                    <option value="any">ä»»ä½•æ—¶é•¿</option>
                                    <option value="short">çŸ­äº4åˆ†é’Ÿ</option>
                                    <option value="medium">4-20åˆ†é’Ÿ</option>
                                    <option value="long">é•¿äº20åˆ†é’Ÿ</option>
                                </select>
            </div>
                            <div>
                                <label class="block text-xs text-white/60 mb-2">è§†é¢‘è´¨é‡</label>
                                <select id="videoDefinition" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm">
                                    <option value="any">ä»»ä½•è´¨é‡</option>
                                    <option value="high">é«˜æ¸…</option>
                                    <option value="standard">æ ‡æ¸…</option>
                                </select>
            </div>
        </div>

                        <!-- é«˜çº§ç­›é€‰é€‰é¡¹ -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-xs text-white/60 mb-2">å‘å¸ƒæ—¶é—´ï¼ˆä»ï¼‰</label>
                                <input type="date" id="publishedAfter" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm">
            </div>
                            <div>
                                <label class="block text-xs text-white/60 mb-2">å‘å¸ƒæ—¶é—´ï¼ˆåˆ°ï¼‰</label>
                                <input type="date" id="publishedBefore" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm">
                </div>
                            <div>
                                <label class="block text-xs text-white/60 mb-2">è§‚çœ‹æ•°èŒƒå›´</label>
                                <select id="viewCount" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm">
                                    <option value="any">ä»»ä½•è§‚çœ‹æ•°</option>
                                    <option value="1000+">1000+</option>
                                    <option value="10000+">10000+</option>
                                    <option value="100000+">100000+</option>
                                    <option value="1000000+">100ä¸‡+</option>
                                    <option value="10000000+">1000ä¸‡+</option>
                                </select>
                </div>
                            <div>
                                <label class="block text-xs text-white/60 mb-2">è¯­è¨€</label>
                                <select id="relevanceLanguage" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm">
                                    <option value="any">ä»»ä½•è¯­è¨€</option>
                                    <option value="zh">ä¸­æ–‡</option>
                                    <option value="en">è‹±æ–‡</option>
                                    <option value="ja">æ—¥æ–‡</option>
                                    <option value="ko">éŸ©æ–‡</option>
                                    <option value="es">è¥¿ç­ç‰™æ–‡</option>
                                    <option value="fr">æ³•æ–‡</option>
                                    <option value="de">å¾·æ–‡</option>
                                </select>
                    </div>
                </div>

                        <!-- æ›´å¤šç­›é€‰é€‰é¡¹ -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-xs text-white/60 mb-2">è§†é¢‘åˆ†ç±»</label>
                                <select id="videoCategoryId" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm">
                                    <option value="any">ä»»ä½•åˆ†ç±»</option>
                                    <option value="1">ç”µå½±å’ŒåŠ¨ç”»</option>
                                    <option value="2">æ±½è½¦</option>
                                    <option value="10">éŸ³ä¹</option>
                                    <option value="15">å® ç‰©å’ŒåŠ¨ç‰©</option>
                                    <option value="17">ä½“è‚²</option>
                                    <option value="19">æ—…è¡Œå’Œæ´»åŠ¨</option>
                                    <option value="20">æ¸¸æˆ</option>
                                    <option value="22">äººç‰©å’Œåšå®¢</option>
                                    <option value="23">å–œå‰§</option>
                                    <option value="24">å¨±ä¹</option>
                                    <option value="25">æ–°é—»å’Œæ”¿æ²»</option>
                                    <option value="26">ç”Ÿæ´»æ–¹å¼</option>
                                    <option value="27">æ•™è‚²</option>
                                    <option value="28">ç§‘å­¦æŠ€æœ¯</option>
                                    <option value="29">éè¥åˆ©ç»„ç»‡å’Œè¡ŒåŠ¨ä¸»ä¹‰</option>
                                </select>
            </div>
                            <div>
                                <label class="block text-xs text-white/60 mb-2">åœ°åŒºé™åˆ¶</label>
                                <select id="regionCode" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm">
                                    <option value="any">ä»»ä½•åœ°åŒº</option>
                                    <option value="CN">ä¸­å›½</option>
                                    <option value="US">ç¾å›½</option>
                                    <option value="JP">æ—¥æœ¬</option>
                                    <option value="KR">éŸ©å›½</option>
                                    <option value="GB">è‹±å›½</option>
                                    <option value="DE">å¾·å›½</option>
                                    <option value="FR">æ³•å›½</option>
                                    <option value="CA">åŠ æ‹¿å¤§</option>
                                    <option value="AU">æ¾³å¤§åˆ©äºš</option>
                                </select>
        </div>
                            <div>
                                <label class="block text-xs text-white/60 mb-2">å®‰å…¨æœç´¢</label>
                                <select id="safeSearch" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm">
                                    <option value="moderate">ä¸­ç­‰</option>
                                    <option value="strict">ä¸¥æ ¼</option>
                                    <option value="none">æ— é™åˆ¶</option>
                </select>
            </div>
        </div>

                        <!-- ä½¿ç”¨è¯´æ˜ -->
                        <div class="mt-4">
                            <button onclick="toggleUsageGuide()" class="flex items-center gap-2 text-sm text-blue-300 hover:text-blue-200 transition-colors px-3 py-2 rounded-lg hover:bg-blue-500/10">
                                <i data-lucide="info" class="w-4 h-4"></i>
                                <span id="usageGuideToggle">æ˜¾ç¤ºä½¿ç”¨è¯´æ˜</span>
                            </button>
                            
                            <div id="usageGuide" class="hidden mt-4 p-4 bg-blue-500/10 border border-blue-500/20 rounded-lg">
                                <h3 class="text-lg font-semibold text-blue-200 mb-3">ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
                                
                                <div class="space-y-4 text-sm">
                                    <div>
                                        <h4 class="font-medium text-blue-100 mb-2">ğŸ”‘ ç¬¬ä¸€æ­¥ï¼šé…ç½® API Key</h4>
                                        <p class="text-white/80">ç‚¹å‡»å³ä¸Šè§’è®¾ç½®æŒ‰é’®ï¼Œè¾“å…¥æ‚¨çš„ YouTube Data API v3 Keyã€‚å¦‚æœæ²¡æœ‰ï¼Œè¯·è®¿é—® <a href="https://console.developers.google.com/" target="_blank" class="text-blue-300 hover:underline">Google Cloud Console</a> åˆ›å»ºã€‚</p>
                                    </div>
                                    
                                    <div>
                                        <h4 class="font-medium text-blue-100 mb-2">ğŸ” ç¬¬äºŒæ­¥ï¼šæœç´¢è§†é¢‘</h4>
                                        <p class="text-white/80">åœ¨æœç´¢æ¡†ä¸­è¾“å…¥å…³é”®è¯ã€è§†é¢‘æ ‡é¢˜ï¼Œæˆ–ç›´æ¥ç²˜è´´ YouTube è§†é¢‘é“¾æ¥ã€‚é€‰æ‹©æœç´¢ç»“æœæ•°é‡ï¼Œç‚¹å‡»æœç´¢æŒ‰é’®ã€‚</p>
                                    </div>
                                    
                                    <div>
                                        <h4 class="font-medium text-blue-100 mb-2">ğŸ“ ç¬¬ä¸‰æ­¥ï¼šè·å–è¯„è®º</h4>
                                        <p class="text-white/80">åœ¨æœç´¢ç»“æœä¸­ï¼Œç‚¹å‡»è§†é¢‘å¡ç‰‡ä¸Šçš„"è·å–è¯„è®º"æŒ‰é’®ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨è·å–è¯¥è§†é¢‘çš„æ‰€æœ‰è¯„è®ºå’Œå›å¤ã€‚</p>
                                    </div>
                                    
                                    <div>
                                        <h4 class="font-medium text-blue-100 mb-2">ğŸ“Š ç¬¬å››æ­¥ï¼šå¯¼å‡ºæ•°æ®</h4>
                                        <p class="text-white/80">å‹¾é€‰è¦å¯¼å‡ºçš„è§†é¢‘ï¼Œç‚¹å‡»"å¯¼å‡ºè¯„è®º"æŒ‰é’®ã€‚é€‰æ‹©å¯¼å‡ºæ ¼å¼ï¼ˆJSONã€CSVã€TXTã€HTMLï¼‰ï¼Œæ–‡ä»¶å°†è‡ªåŠ¨ä¸‹è½½ã€‚</p>
                                    </div>
                                    
                                    <div class="bg-yellow-500/20 border border-yellow-500/30 rounded-lg p-3">
                                        <h4 class="font-medium text-yellow-200 mb-2">ğŸ’¡ ä½¿ç”¨æŠ€å·§</h4>
                                        <ul class="text-white/80 space-y-1 text-xs">
                                            <li>â€¢ æ”¯æŒæ‰¹é‡å¤„ç†å¤šä¸ªè§†é¢‘çš„è¯„è®º</li>
                                            <li>â€¢ è¯„è®ºæ•°æ®åŒ…å«ä½œè€…ã€æ—¶é—´ã€ç‚¹èµæ•°ç­‰è¯¦ç»†ä¿¡æ¯</li>
                                            <li>â€¢ å›å¤è¯„è®ºä¼šè‡ªåŠ¨å…³è”åˆ°ä¸»è¯„è®º</li>
                                            <li>â€¢ å¯¼å‡ºæ ¼å¼æ”¯æŒå¤šç§æ•°æ®åˆ†æå·¥å…·</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-3">
                                        <h4 class="font-medium text-green-200 mb-2">ğŸš€ é«˜çº§åŠŸèƒ½</h4>
                                        <ul class="text-white/80 space-y-1 text-xs">
                                            <li>â€¢ æ™ºèƒ½è¯„è®ºåˆ†æï¼ˆæƒ…æ„Ÿåˆ†æã€è¯­è¨€æ£€æµ‹ï¼‰</li>
                                            <li>â€¢ å†å²è®°å½•ç®¡ç†ï¼ˆæœç´¢å†å²ã€æŸ¥çœ‹å†å²ï¼‰</li>
                                            <li>â€¢ æ•°æ®ç»Ÿè®¡å›¾è¡¨ï¼ˆæ´»åŠ¨è¶‹åŠ¿ã€çƒ­é—¨æœç´¢ï¼‰</li>
                                            <li>â€¢ æ™ºèƒ½ç­›é€‰å’Œæ’åºåŠŸèƒ½</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ç­›é€‰æ§åˆ¶æŒ‰é’® -->
                        <div class="flex justify-between items-center mt-4">
                            <button onclick="resetFilters()" class="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm transition-all">
                                é‡ç½®ç­›é€‰
                        </button>
                            <div class="text-xs text-white/60">
                                å·²å¯ç”¨ç­›é€‰: <span id="activeFiltersCount">0</span> é¡¹
                    </div>
                </div>

                        <!-- Search Suggestions -->
                        <div id="searchSuggestions" class="mt-4 hidden">
                            <p class="text-xs text-white/60 mb-2">æœç´¢å»ºè®®ï¼š</p>
                            <div id="suggestionsList" class="flex flex-wrap gap-2"></div>
            </div>
        </div>

                    <!-- Search Results Stats and Actions -->
                    <div id="searchResultsStats" class="panel p-4 mb-4 hidden">
                        <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
                            <!-- Stats -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="text-center">
                                    <div class="text-xs text-white/60 mb-1">æœç´¢ç»“æœ</div>
                                    <div class="text-xl font-bold" id="searchResultsCount">0</div>
            </div>
                                <div class="text-center">
                                    <div class="text-xs text-white/60 mb-1">å·²é€‰ä¸­</div>
                                    <div class="text-xl font-bold" id="selectedCount">0</div>
            </div>
                                <div class="text-center">
                                    <div class="text-xs text-white/60 mb-1">æ€»è§‚çœ‹</div>
                                    <div class="text-xl font-bold" id="totalViews">0</div>
            </div>
                                <div class="text-center">
                                    <div class="text-xs text-white/60 mb-1">æ€»ç‚¹èµ</div>
                                    <div class="text-xl font-bold" id="totalLikes">0</div>
                                </div>
    </div>

                            <!-- Actions -->
                            <div class="flex flex-wrap gap-2">
                                <button onclick="selectAll()" class="px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm transition-all">
                                    å…¨é€‰
                                </button>
                                <button onclick="deselectAll()" class="px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm transition-all">
                                    å–æ¶ˆå…¨é€‰
                                </button>
                                <button onclick="fetchCommentsForSelectedSearchResults()" class="px-3 py-2 bg-green-500/20 hover:bg-green-500/30 text-green-300 rounded-lg text-sm transition-all">
                                    æ‰¹é‡è·å–è¯„è®º
                                </button>
                                <button onclick="copySelectedUrls()" class="px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm transition-all">
                                    å¤åˆ¶URL
                                </button>
                                <button onclick="exportSearchResults()" class="px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm transition-all">
                                    å¯¼å‡ºæ•°æ®
                                </button>
                                <button onclick="exportComments()" class="px-3 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-300 rounded-lg text-sm transition-all">
                                    å¯¼å‡ºè¯„è®º
                                </button>
                                
            </div>
                </div>
                </div>

                    <!-- Search Results -->
                    <div id="searchResults" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Results will be inserted here -->
                    </div>
                    
                    <!-- Loading State -->
                    <div id="searchLoading" class="hidden text-center py-12">
                        <div class="inline-flex items-center gap-3">
                            <div class="w-8 h-8 border-2 border-red-500 border-t-transparent rounded-full animate-spin"></div>
                            <span>æœç´¢ä¸­...</span>
                        </div>
                        </div>
                    </div>
                </div>


            

            

            
            <!-- History Tab -->
            <div id="content-history" class="tab-content p-6 hidden">
                <div class="max-w-6xl mx-auto">
                    <!-- History Usage Guide -->
                    <div class="panel p-6 mb-6 bg-blue-500/10 border border-blue-500/20">
                        <h3 class="text-lg font-semibold text-blue-200 mb-3">ğŸ“Š å†å²è®°å½•åŠŸèƒ½è¯´æ˜</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <h4 class="font-medium text-blue-100 mb-2">ğŸ” æœç´¢å†å²</h4>
                                <p class="text-white/80">ç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•æ‚¨çš„æœç´¢å…³é”®è¯å’Œé¢‘ç‡ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿæ‰¾åˆ°å¸¸ç”¨çš„æœç´¢å†…å®¹ã€‚</p>
                            </div>
                            <div>
                                <h4 class="font-medium text-blue-100 mb-2">ğŸ‘ï¸ æµè§ˆå†å²</h4>
                                <p class="text-white/80">è®°å½•æ‚¨æŸ¥çœ‹è¿‡çš„è§†é¢‘ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ ‡é¢˜ã€é¢‘é“å’ŒæŸ¥çœ‹æ—¶é—´ï¼Œæ–¹ä¾¿åç»­åˆ†æã€‚</p>
                            </div>
                            <div>
                                <h4 class="font-medium text-blue-100 mb-2">ğŸ“ˆ æ´»åŠ¨ç»Ÿè®¡</h4>
                                <p class="text-white/80">æä¾›7å¤©å†…çš„æ´»åŠ¨è¶‹åŠ¿å›¾è¡¨ï¼Œå¸®åŠ©æ‚¨äº†è§£ä½¿ç”¨æ¨¡å¼å’Œæ´»è·ƒæ—¶æ®µã€‚</p>
                            </div>
                            <div>
                                <h4 class="font-medium text-blue-100 mb-2">ğŸ—‘ï¸ æ•°æ®ç®¡ç†</h4>
                                <p class="text-white/80">æ”¯æŒæ¸…é™¤å†å²è®°å½•ï¼Œä¿æŠ¤æ‚¨çš„éšç§ã€‚æ‰€æœ‰æ•°æ®ä»…å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ã€‚</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- History Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="panel p-6">
                            <h3 class="text-sm font-medium mb-4">çƒ­é—¨æœç´¢</h3>
                            <div id="topSearches" class="space-y-2"></div>
                        </div>
                        <div class="panel p-6">
                            <h3 class="text-sm font-medium mb-4">æœ€è¿‘æµè§ˆ</h3>
                            <div id="recentViews" class="space-y-2"></div>
                    </div>
                        <div class="panel p-6">
                            <h3 class="text-sm font-medium mb-4">æ´»åŠ¨ç»Ÿè®¡</h3>
                            <canvas id="activityChart"></canvas>
        </div>
    </div>

                    <!-- History List -->
                    <div class="panel p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-medium">å†å²è®°å½•</h3>
                            <button onclick="clearHistory()" class="text-xs text-red-400 hover:text-red-300">
                                æ¸…é™¤å†å²
                    </button>
                </div>
                        <div id="historyList" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                            <!-- History items will be inserted here -->
            </div>
                    </div>
                        </div>
                    </div>
        </main>
                    </div>
                    
    <!-- Notification System -->
    <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="panel max-w-2xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">è®¾ç½®</h2>
                        <button onclick="closeSettings()" class="p-2 hover:bg-white/10 rounded-lg">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                
                    <!-- API Settings -->
                    <div class="mb-6">
                        <h3 class="text-sm font-medium mb-3">APIé…ç½®</h3>
                        
                        <!-- API Key Input -->
                        <input type="text" id="apiKey" placeholder="YouTube APIå¯†é’¥" 
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-sm mb-3">
                        <button onclick="saveApiKey()" class="btn-gradient text-white rounded-lg px-6 py-2 text-sm">
                            ä¿å­˜APIå¯†é’¥
                        </button>
                        
                        <!-- APIè·å–è¯´æ˜ -->
                        <div class="mt-4 p-4 bg-white/5 rounded-lg border border-white/10">
                            <h4 class="text-sm font-medium mb-2 text-blue-300">å¦‚ä½•è·å–YouTube APIå¯†é’¥ï¼Ÿ</h4>
                            <div class="text-xs text-white/60 space-y-2">
                                <p><strong>æ­¥éª¤1ï¼š</strong>è®¿é—® <a href="https://console.developers.google.com/" target="_blank" class="text-blue-400 hover:underline">Google Cloud Console</a></p>
                                <p><strong>æ­¥éª¤2ï¼š</strong>åˆ›å»ºæ–°é¡¹ç›®æˆ–é€‰æ‹©ç°æœ‰é¡¹ç›®</p>
                                <p><strong>æ­¥éª¤3ï¼š</strong>å¯ç”¨ YouTube Data API v3</p>
                                <p><strong>æ­¥éª¤4ï¼š</strong>åˆ›å»ºå‡­æ® â†’ APIå¯†é’¥</p>
                                <p><strong>æ­¥éª¤5ï¼š</strong>å¤åˆ¶ç”Ÿæˆçš„APIå¯†é’¥åˆ°ä¸Šæ–¹è¾“å…¥æ¡†</p>
                                <p class="text-yellow-300 mt-2">âš ï¸ æ³¨æ„ï¼šAPIå¯†é’¥æœ‰ä½¿ç”¨é…é¢é™åˆ¶ï¼Œè¯·åˆç†ä½¿ç”¨</p>
                        </div>
                        </div>
                        
                        <!-- åŠŸèƒ½è¯´æ˜ -->
                        <div class="mt-4 p-4 bg-white/5 rounded-lg border border-white/10">
                            <h4 class="text-sm font-medium mb-2 text-green-300">ä½¿ç”¨è¯´æ˜</h4>
                            <div class="text-xs text-white/60 space-y-2">
                                <p><strong>ğŸ” æœç´¢è§†é¢‘ï¼š</strong>è¾“å…¥å…³é”®è¯æœç´¢YouTubeè§†é¢‘ï¼Œæ”¯æŒå¤šç§ç­›é€‰æ¡ä»¶</p>
                                <p><strong>ğŸ’¬ è·å–è¯„è®ºï¼š</strong>ç‚¹å‡»"è·å–è¯„è®º"æŒ‰é’®è·å–è§†é¢‘è¯„è®ºæ•°æ®</p>
                                <p><strong>ğŸ“Š æ‰¹é‡æ“ä½œï¼š</strong>é€‰æ‹©å¤šä¸ªè§†é¢‘è¿›è¡Œæ‰¹é‡è¯„è®ºè·å–ã€å¯¼å‡ºç­‰æ“ä½œ</p>
                                <p><strong>ğŸ“ å¯¼å‡ºæ•°æ®ï¼š</strong>æ”¯æŒJSONã€CSVã€TXTã€HTMLå¤šç§æ ¼å¼å¯¼å‡º</p>
                                <p><strong>ğŸ“š å†å²è®°å½•ï¼š</strong>è‡ªåŠ¨è®°å½•æœç´¢å’Œæµè§ˆå†å²ï¼Œæ”¯æŒå¿«é€Ÿé‡æ–°æœç´¢</p>
                    </div>
                    </div>
                    </div>
                    
                    <!-- Search Settings -->
                    <div class="mb-6">
                        <h3 class="text-sm font-medium mb-3">æœç´¢è®¾ç½®</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-white/60">é»˜è®¤æœç´¢ç»“æœæ•°</label>
                                <input type="number" id="defaultMaxResults" value="50" 
                                    class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-sm">
            </div>
                            <div>
                                <label class="text-xs text-white/60">æ¯ä¸ªè§†é¢‘æœ€å¤§è¯„è®ºæ•°</label>
                                <input type="number" id="defaultMaxComments" value="100" 
                                    class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-sm">
            </div>
        </div>
    </div>

                    <!-- Storage Settings -->
                    <div class="mb-6">
                        <h3 class="text-sm font-medium mb-3">å­˜å‚¨ç®¡ç†</h3>
                        <div class="flex gap-2">
                            <button onclick="clearCache()" class="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm">
                                æ¸…é™¤ç¼“å­˜
                    </button>
                            <button onclick="exportAllData()" class="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm">
                                å¯¼å‡ºæ‰€æœ‰æ•°æ®
                            </button>
                            <button onclick="importData()" class="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm">
                                å¯¼å…¥æ•°æ®
                    </button>
                </div>
            </div>
                                </div>
                            </div>
                                </div>
                                </div>
    
    <!-- Scripts -->
    <!-- APIå¯†é’¥é…ç½®æ–‡ä»¶ - ç”¨äºDockeréƒ¨ç½²ï¼Œè¯·åœ¨æ­¤æ–‡ä»¶ä¸­é…ç½®æ‚¨çš„APIå¯†é’¥ -->
    <script src="api-key-config.js"></script>
    <script src="assets/js/comment-manager-v2.js"></script>
    <script src="assets/js/history-manager-v2.js"></script>
    
    <script>
        // Global variables
        // ä¼˜å…ˆä½¿ç”¨åµŒå…¥çš„APIå¯†é’¥ï¼ˆç”¨äºDockeréƒ¨ç½²ï¼‰
        let apiKey = localStorage.getItem('youtube_api_key') || '';
        
        // å¦‚æœå­˜åœ¨åµŒå…¥çš„APIå¯†é’¥é…ç½®ï¼Œè‡ªåŠ¨ä½¿ç”¨
        if (!apiKey && window.EMBEDDED_API_KEYS && Array.isArray(window.EMBEDDED_API_KEYS) && window.EMBEDDED_API_KEYS.length > 0) {
            const validKeys = window.EMBEDDED_API_KEYS.filter(key => 
                key && 
                key !== 'YOUR_API_KEY_HERE' && 
                key.length > 20 && 
                key.startsWith('AIzaSy')
            );
            
            if (validKeys.length > 0) {
                // ä½¿ç”¨ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„åµŒå…¥å¯†é’¥
                apiKey = validKeys[0];
                localStorage.setItem('youtube_api_key', apiKey);
                console.log('å·²è‡ªåŠ¨ä½¿ç”¨åµŒå…¥çš„APIå¯†é’¥:', apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4));
            }
        }
        let videos = JSON.parse(localStorage.getItem('youtube_videos') || '[]');
        let selectedVideos = new Set();
        let commentManager = null;
        let historyManager = new HistoryManagerV2();
        let config = {};
        
        // Load configuration
        fetch('config.json')
            .then(res => res.json())
            .then(data => {
                config = data;
                document.getElementById('defaultMaxResults').value = config.api.maxVideosPerSearch;
                document.getElementById('defaultMaxComments').value = config.api.maxCommentsPerVideo;
            })
            .catch(err => console.error('Failed to load config:', err));
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            initializeApp();
        });
        
        function initializeApp() {
            // Check API key
            if (apiKey) {
                commentManager = new CommentManagerV2(apiKey);
                updateApiStatus(true);
            } else {
                updateApiStatus(false);
            }
            
            // Load data
            loadVideos();
            updateStats();
            loadHistory();
            
            // Setup event listeners
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
            
            // Load search suggestions
            updateSearchSuggestions();
            
            // Initialize filter count
            updateActiveFiltersCount();
            
            // Add event listeners for filter changes
            const filterElements = [
                'searchOrder', 'videoType', 'videoDuration', 'videoDefinition', 
                'viewCount', 'relevanceLanguage', 'videoCategoryId', 'regionCode',
                'safeSearch', 'publishedAfter', 'publishedBefore'
            ];
            
            filterElements.forEach(filterId => {
                const element = document.getElementById(filterId);
                if (element) {
                    element.addEventListener('change', updateActiveFiltersCount);
                }
            });
        }
        
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('tab-active');
            });
            
            // Show selected tab
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            
            // Update content based on tab
            if (tabName === 'history') {
                loadHistory();
            }
        }
        
        // Search functionality
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;
            
            if (!apiKey) {
                alert('è¯·å…ˆé…ç½®APIå¯†é’¥');
                showSettings();
                return;
            }
            
            const maxResults = document.getElementById('maxResults').value;
            const order = document.getElementById('searchOrder').value;
            const videoType = document.getElementById('videoType').value;
            const videoDuration = document.getElementById('videoDuration').value;
            const videoDefinition = document.getElementById('videoDefinition').value;
            const viewCount = document.getElementById('viewCount').value;
            const relevanceLanguage = document.getElementById('relevanceLanguage').value;
            const videoCategoryId = document.getElementById('videoCategoryId').value;
            const regionCode = document.getElementById('regionCode').value;
            const safeSearch = document.getElementById('safeSearch').value;
            const publishedAfter = document.getElementById('publishedAfter').value;
            const publishedBefore = document.getElementById('publishedBefore').value;
            
            // Show loading and hide stats
            document.getElementById('searchLoading').classList.remove('hidden');
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchResultsStats').classList.add('hidden');
            selectedVideos.clear();
            
            // Add to history
            historyManager.addSearchHistory(query, 'keyword');
            
            try {
                // æ„å»ºæœç´¢å‚æ•° - ä¿®å¤ç¼–ç å’Œå‚æ•°é—®é¢˜
                const params = new URLSearchParams({
                    part: 'snippet',
                    q: query, // URLSearchParamsä¼šè‡ªåŠ¨ç¼–ç ï¼Œä¸éœ€è¦æ‰‹åŠ¨encodeURIComponent
                    type: 'video',
                    maxResults: maxResults,
                    order: order,
                    key: apiKey
                });
                
                // æ·»åŠ è§†é¢‘ç±»å‹ç­›é€‰
                if (videoType && videoType !== 'any') {
                    params.append('videoType', videoType);
                }
                
                // æ·»åŠ è§†é¢‘æ—¶é•¿ç­›é€‰
                if (videoDuration && videoDuration !== 'any') {
                    params.append('videoDuration', videoDuration);
                }
                
                // æ·»åŠ è§†é¢‘è´¨é‡ç­›é€‰
                if (videoDefinition && videoDefinition !== 'any') {
                    params.append('videoDefinition', videoDefinition);
                }
                
                // æ³¨æ„ï¼šYouTube APIä¸æ”¯æŒviewCountä½œä¸ºæœç´¢å‚æ•°
                // è§‚çœ‹æ•°ç­›é€‰éœ€è¦åœ¨è·å–ç»“æœåè¿‡æ»¤ï¼Œè¿™é‡Œç§»é™¤
                // if (viewCount && viewCount !== 'any') {
                //     const minViews = viewCount.replace('+', '');
                //     params.append('viewCount', minViews);
                // }
                
                // æ·»åŠ è¯­è¨€ç­›é€‰ï¼ˆå¯é€‰ï¼Œå¯èƒ½é™åˆ¶ç»“æœï¼‰
                if (relevanceLanguage && relevanceLanguage !== 'any') {
                    params.append('relevanceLanguage', relevanceLanguage);
                }
                
                // æ·»åŠ è§†é¢‘åˆ†ç±»ç­›é€‰ï¼ˆå¯é€‰ï¼Œå¯èƒ½é™åˆ¶ç»“æœï¼‰
                if (videoCategoryId && videoCategoryId !== 'any') {
                    params.append('videoCategoryId', videoCategoryId);
                }
                
                // æ·»åŠ åœ°åŒºé™åˆ¶ç­›é€‰ï¼ˆå¯é€‰ï¼Œå¯èƒ½é™åˆ¶ç»“æœï¼‰
                if (regionCode && regionCode !== 'any') {
                    params.append('regionCode', regionCode);
                }
                
                // æ·»åŠ å®‰å…¨æœç´¢ç­›é€‰
                if (safeSearch && safeSearch !== 'moderate') {
                    params.append('safeSearch', safeSearch);
                }
                
                // åªæœ‰å½“æ—¥æœŸæœ‰å€¼æ—¶æ‰æ·»åŠ åˆ°å‚æ•°ä¸­
                if (publishedAfter) {
                    params.append('publishedAfter', publishedAfter + 'T00:00:00Z');
                }
                if (publishedBefore) {
                    params.append('publishedBefore', publishedBefore + 'T23:59:59Z');
                }
                
                // æ·»åŠ è°ƒè¯•æ—¥å¿—
                console.log('æœç´¢å‚æ•°:', params.toString());
                console.log('æœç´¢å…³é”®è¯:', query);
                console.log('ç­›é€‰æ¡ä»¶:', {
                    videoType, videoDuration, videoDefinition,
                    relevanceLanguage, videoCategoryId, regionCode, safeSearch
                });
                
                const searchUrl = `https://www.googleapis.com/youtube/v3/search?${params.toString()}`;
                console.log('æœç´¢URL:', searchUrl);
                
                const response = await fetch(searchUrl);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
                
                const data = await response.json();
                
                // æ·»åŠ è°ƒè¯•æ—¥å¿—
                console.log('æœç´¢å“åº”:', data);
                console.log('è¿”å›ç»“æœæ•°é‡:', data.items?.length || 0);
                console.log('æ€»ç»“æœæ•°:', data.pageInfo?.totalResults || 0);
                
                if (!data.items || data.items.length === 0) {
                    const errorMsg = data.error ? `APIé”™è¯¯: ${data.error.message}` : 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è§†é¢‘';
                    console.error('æœç´¢å¤±è´¥:', data.error || 'æ— ç»“æœ');
                    document.getElementById('searchResults').innerHTML = `
                        <div class="text-center text-white/60 py-8">
                            <p>${errorMsg}</p>
                            <p class="text-xs mt-2">æç¤ºï¼šè¯·æ£€æŸ¥ç­›é€‰æ¡ä»¶æ˜¯å¦è¿‡äºä¸¥æ ¼ï¼Œæˆ–å°è¯•æ¸…é™¤ç­›é€‰æ¡ä»¶</p>
                        </div>`;
                    return;
                }
                
                // å¦‚æœæœ‰æ€»ç»“æœæ•°ä½†è¿”å›æ•°é‡å°‘ï¼Œæç¤ºç”¨æˆ·
                if (data.pageInfo && data.pageInfo.totalResults > data.items.length) {
                    console.log(`æ‰¾åˆ° ${data.pageInfo.totalResults} ä¸ªç»“æœï¼Œä½†åªè¿”å›äº† ${data.items.length} ä¸ª`);
                }
                
                // Get video details - è¿‡æ»¤æ‰æ— æ•ˆçš„videoId
                const videoIds = data.items
                    .map(item => item.id?.videoId)
                    .filter(id => id) // è¿‡æ»¤æ‰undefinedæˆ–null
                    .join(',');
                
                if (!videoIds) {
                    console.error('æ²¡æœ‰æœ‰æ•ˆçš„è§†é¢‘ID');
                    document.getElementById('searchResults').innerHTML = '<p class="text-center text-white/60 py-8">è·å–è§†é¢‘è¯¦æƒ…å¤±è´¥ï¼šæ²¡æœ‰æœ‰æ•ˆçš„è§†é¢‘ID</p>';
                    return;
                }
                
                console.log('è·å–è§†é¢‘è¯¦æƒ…ï¼ŒIDs:', videoIds.substring(0, 100) + '...');
                
                const detailsResponse = await fetch(
                    `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${videoIds}&key=${apiKey}`
                );
                
                if (!detailsResponse.ok) {
                    const errorData = await detailsResponse.json();
                    throw new Error(`è·å–è§†é¢‘è¯¦æƒ…å¤±è´¥: ${detailsResponse.status} - ${errorData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
                
                const detailsData = await detailsResponse.json();
                
                console.log('è§†é¢‘è¯¦æƒ…å“åº”:', detailsData);
                console.log('è§†é¢‘è¯¦æƒ…æ•°é‡:', detailsData.items?.length || 0);
                
                if (!detailsData.items || detailsData.items.length === 0) {
                    console.error('æ²¡æœ‰è·å–åˆ°è§†é¢‘è¯¦æƒ…');
                    document.getElementById('searchResults').innerHTML = '<p class="text-center text-white/60 py-8">è·å–è§†é¢‘è¯¦æƒ…å¤±è´¥</p>';
                    return;
                }
                
                // å¦‚æœè®¾ç½®äº†è§‚çœ‹æ•°ç­›é€‰ï¼Œåœ¨å®¢æˆ·ç«¯è¿‡æ»¤ï¼ˆå› ä¸ºYouTube APIä¸æ”¯æŒviewCountå‚æ•°ï¼‰
                let filteredItems = detailsData.items;
                if (viewCount && viewCount !== 'any') {
                    const minViews = parseInt(viewCount.replace(/[^0-9]/g, '')) || 0;
                    filteredItems = detailsData.items.filter(item => {
                        const views = parseInt(item.statistics?.viewCount || 0);
                        return views >= minViews;
                    });
                    console.log(`è§‚çœ‹æ•°ç­›é€‰: ä» ${detailsData.items.length} ä¸ªç»“æœç­›é€‰åˆ° ${filteredItems.length} ä¸ª`);
                }
                
                // Display results
                displaySearchResults(filteredItems);
                
                // Update suggestions
                updateSearchSuggestions();
                
            } catch (error) {
                console.error('Search error:', error);
                alert('æœç´¢å¤±è´¥: ' + error.message);
            } finally {
                document.getElementById('searchLoading').classList.add('hidden');
            }
        }
        
        function displaySearchResults(items) {
            const container = document.getElementById('searchResults');
            
            if (!items || items.length === 0) {
                container.innerHTML = '<p class="text-center text-white/60 py-8">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è§†é¢‘</p>';
                return;
            }
            
            container.innerHTML = items.map(item => {
                // å®‰å…¨åœ°è®¿é—®å¯èƒ½ä¸å­˜åœ¨çš„å±æ€§
                const thumbnail = item.snippet?.thumbnails?.medium?.url || 'https://via.placeholder.com/320x180?text=No+Thumbnail';
                const title = item.snippet?.title || 'æœªçŸ¥æ ‡é¢˜';
                const channel = item.snippet?.channelTitle || 'æœªçŸ¥é¢‘é“';
                const views = item.statistics?.viewCount || 0;
                const likes = item.statistics?.likeCount || 0;
                const comments = item.statistics?.commentCount || 0;
                
                return `
                                        <div class="glass-card p-4">
                        <div class="flex items-start gap-3 mb-3">
                            <input type="checkbox" class="w-5 h-5 mt-1" 
                                onchange="toggleVideoSelection('${item.id}')">
                            <img src="${thumbnail}" alt="${title}" 
                                class="w-full h-48 object-cover rounded-lg cursor-pointer hover:opacity-80 transition-opacity"
                                onclick="openVideo('${item.id}')">
                                </div>
                        <h3 class="font-medium text-sm mb-1 line-clamp-2">${title}</h3>
                        <p class="text-xs text-white/60 mb-3">${channel}</p>
                        <div class="flex justify-between text-xs text-white/60 mb-3">
                            <span>${formatNumber(views)} è§‚çœ‹</span>
                            <span>${formatNumber(likes)} ç‚¹èµ</span>
                            <span>${formatNumber(comments)} è¯„è®º</span>
                                </div>
                        <div class="flex gap-2">
                            <button onclick="showCommentOptions('${item.id}', this, ${comments})" 
                                class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-all">
                                è·å–è¯„è®º
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯å’Œæ“ä½œæŒ‰é’®
            document.getElementById('searchResultsStats').classList.remove('hidden');
            updateSearchResultsStats(items);
        }
        

        
        function formatVideoData(item) {
            return {
                id: item.id,
                title: item.snippet?.title || 'æœªçŸ¥æ ‡é¢˜',
                channel: item.snippet?.channelTitle || 'æœªçŸ¥é¢‘é“',
                channelId: item.snippet?.channelId || '',
                thumbnail: item.snippet?.thumbnails?.medium?.url || 'https://via.placeholder.com/320x180?text=No+Thumbnail',
                description: item.snippet?.description || '',
                publishedAt: item.snippet?.publishedAt || new Date().toISOString(),
                duration: item.contentDetails?.duration || 'PT0S',
                views: parseInt(item.statistics?.viewCount || 0),
                likes: parseInt(item.statistics?.likeCount || 0),
                comments: parseInt(item.statistics?.commentCount || 0),
                url: `https://www.youtube.com/watch?v=${item.id}`
            };
        }
        
        // Video management
        function loadVideos() {
            const container = document.getElementById('videoList');
            
            // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
            if (!container) {
                console.log('Video list container not found, skipping loadVideos');
                return;
            }
            
            if (videos.length === 0) {
                container.innerHTML = '<p class="text-center text-white/60 py-8">è¿˜æ²¡æœ‰æ·»åŠ è§†é¢‘</p>';
                return;
            }
            
            container.innerHTML = videos.map(video => `
                <div class="panel p-4 flex items-center gap-4">
                    <input type="checkbox" class="w-5 h-5" 
                        ${selectedVideos.has(video.id) ? 'checked' : ''}
                        onchange="toggleVideoSelection('${video.id}')">
                    <img src="${video.thumbnail}" alt="${video.title}" 
                        class="w-24 h-16 object-cover rounded">
                    <div class="flex-1">
                        <h3 class="font-medium text-sm">${video.title}</h3>
                        <p class="text-xs text-white/60">${video.channel}</p>
                            </div>
                    <div class="text-right text-xs text-white/60">
                        <div>${formatNumber(video.views)} è§‚çœ‹</div>
                        <div>${formatNumber(video.likes)} ç‚¹èµ</div>
                        <div>${formatNumber(video.comments)} è¯„è®º</div>
                            </div>
                    <div class="flex gap-2">
                        <button onclick="showCommentOptions('${video.id}', this, ${video.comments})" 
                            class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">
                            è·å–è¯„è®º
                        </button>
                        <button onclick="removeVideo('${video.id}')" 
                            class="px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700">
                            åˆ é™¤
                        </button>
                    </div>
                        </div>
            `).join('');
            
            updateStats();
        }
        
        function toggleVideoSelection(videoId) {
            if (selectedVideos.has(videoId)) {
                selectedVideos.delete(videoId);
            } else {
                selectedVideos.add(videoId);
            }
            updateStats();
        }
        
        function selectAll() {
            videos.forEach(v => selectedVideos.add(v.id));
            loadVideos();
        }
        
        function deselectAll() {
            selectedVideos.clear();
            loadVideos();
        }
        
        function deleteSelected() {
            if (confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„è§†é¢‘å—ï¼Ÿ')) {
                videos = videos.filter(v => !selectedVideos.has(v.id));
                selectedVideos.clear();
                saveVideos();
                loadVideos();
            }
        }
        
        async function fetchCommentsForSelected() {
            if (selectedVideos.size === 0) {
                showNotification('è¯·å…ˆé€‰æ‹©è§†é¢‘', 'warning');
                return;
            }

            const selectedVideosList = videos.filter(v => selectedVideos.has(v.id));
            const totalVideos = selectedVideosList.length;
            let completedCount = 0;
            let failedCount = 0;

            showNotification(`å¼€å§‹ä¸º ${totalVideos} ä¸ªè§†é¢‘è·å–å…¨éƒ¨è¯„è®º...`, 'info');

            for (const video of selectedVideosList) {
                try {
                    await fetchCommentsForVideo(video.id);
                    completedCount++;
                    
                    // é¿å…APIé™åˆ¶ï¼Œæ·»åŠ å»¶è¿Ÿ
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.error(`Failed to fetch comments for ${video.id}:`, error);
                    failedCount++;
                }
            }

            showNotification(`æ‰¹é‡è¯„è®ºè·å–å®Œæˆï¼æˆåŠŸ: ${completedCount}, å¤±è´¥: ${failedCount}`, 'success');
            loadVideos(); // åˆ·æ–°ç•Œé¢
        }

        // ä¸ºæœç´¢ç»“æœé¡µé¢è®¾è®¡çš„æ‰¹é‡è·å–è¯„è®ºå‡½æ•°
        async function fetchCommentsForSelectedSearchResults() {
            if (selectedVideos.size === 0) {
                showNotification('è¯·å…ˆé€‰æ‹©è§†é¢‘', 'warning');
                return;
            }

            const selectedVideoIds = Array.from(selectedVideos);
            const totalVideos = selectedVideoIds.length;
            let completedCount = 0;
            let failedCount = 0;

            showNotification(`å¼€å§‹ä¸º ${totalVideos} ä¸ªè§†é¢‘è·å–å…¨éƒ¨è¯„è®º...`, 'info');

            for (const videoId of selectedVideoIds) {
                try {
                    // ä¸ºæœç´¢ç»“æœé¡µé¢è°ƒç”¨è¯„è®ºè·å–å‡½æ•°
                    await fetchCommentsForVideo(videoId);
                    completedCount++;
                    
                    // é¿å…APIé™åˆ¶ï¼Œæ·»åŠ å»¶è¿Ÿ
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.error(`Failed to fetch comments for ${videoId}:`, error);
                    failedCount++;
                }
            }

            showNotification(`æ‰¹é‡è¯„è®ºè·å–å®Œæˆï¼æˆåŠŸ: ${completedCount}, å¤±è´¥: ${failedCount}`, 'success');
        }

        // æ˜¾ç¤ºè¯„è®ºè·å–é€‰é¡¹å¯¹è¯æ¡†
        function showCommentOptions(videoId, buttonElement, totalComments) {
            // è·å–é…ç½®çš„é»˜è®¤å€¼
            const defaultMaxComments = parseInt(document.getElementById('defaultMaxComments')?.value) || 
                                      config.api?.maxCommentsPerVideo || 
                                      100;
            
            // åˆ›å»ºæ¨¡æ€å¯¹è¯æ¡†
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50';
            
            // ä¿å­˜buttonElementåˆ°modalå…ƒç´ ä¸Šï¼Œä»¥ä¾¿åç»­è®¿é—®
            modal.dataset.buttonElement = 'stored';
            modal._buttonElement = buttonElement;
            modal._videoId = videoId;
            
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 border border-white/10">
                    <h3 class="text-lg font-semibold mb-4">è·å–è¯„è®ºé€‰é¡¹</h3>
                    <p class="text-sm text-white/60 mb-4">
                        è¯¥è§†é¢‘å…±æœ‰ <span class="text-blue-400 font-medium">${formatNumber(totalComments)}</span> æ¡è¯„è®º
                    </p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">é€‰æ‹©è·å–æ–¹å¼ï¼š</label>
                            <div class="space-y-2">
                                <label class="flex items-center p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition-all">
                                    <input type="radio" name="commentOption" value="all" class="mr-3" ${totalComments <= 100 ? 'checked' : ''}>
                                    <div>
                                        <div class="font-medium">è·å–å…¨éƒ¨è¯„è®º</div>
                                        <div class="text-xs text-white/60">${totalComments <= 100 ? 'ï¼ˆæ¨èï¼‰' : 'ï¼ˆå¯èƒ½æ¶ˆè€—è¾ƒå¤šAPIé…é¢ï¼‰'}</div>
                                    </div>
                                </label>
                                
                                <label class="flex items-center p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition-all">
                                    <input type="radio" name="commentOption" value="limited" class="mr-3" ${totalComments > 100 ? 'checked' : ''}>
                                    <div>
                                        <div class="font-medium">é™åˆ¶æ•°é‡è·å–</div>
                                        <div class="text-xs text-white/60">æœ€å¤šè·å–æŒ‡å®šæ•°é‡çš„è¯„è®º</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div id="commentLimitInput" class="${totalComments <= 100 ? 'hidden' : ''}">
                            <label class="block text-sm font-medium mb-2">æœ€å¤§è¯„è®ºæ•°ï¼š</label>
                            <div class="flex gap-2">
                                <select id="commentLimitSelect" class="flex-1 bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-sm">
                                    <option value="50">50æ¡</option>
                                    <option value="100" selected>100æ¡ï¼ˆé»˜è®¤ï¼‰</option>
                                    <option value="200">200æ¡</option>
                                    <option value="500">500æ¡</option>
                                    <option value="1000">1000æ¡</option>
                                    <option value="custom">è‡ªå®šä¹‰</option>
                                </select>
                                <input type="number" id="commentLimitCustom" 
                                    placeholder="è‡ªå®šä¹‰æ•°é‡" 
                                    min="1" max="${totalComments}"
                                    class="hidden w-32 bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-sm">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button class="cancel-btn flex-1 px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm transition-all">
                            å–æ¶ˆ
                        </button>
                        <button class="confirm-btn flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition-all">
                            ç¡®å®š
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ç»‘å®šå–æ¶ˆæŒ‰é’®äº‹ä»¶
            modal.querySelector('.cancel-btn').addEventListener('click', function() {
                modal.remove();
            });
            
            // ç»‘å®šç¡®è®¤æŒ‰é’®äº‹ä»¶
            modal.querySelector('.confirm-btn').addEventListener('click', function() {
                confirmCommentFetch(modal);
            });
            
            // ç›‘å¬é€‰é¡¹å˜åŒ–
            modal.querySelectorAll('input[name="commentOption"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const limitInput = modal.querySelector('#commentLimitInput');
                    if (this.value === 'limited') {
                        limitInput.classList.remove('hidden');
                    } else {
                        limitInput.classList.add('hidden');
                    }
                });
            });
            
            // ç›‘å¬è‡ªå®šä¹‰é€‰é¡¹
            modal.querySelector('#commentLimitSelect').addEventListener('change', function() {
                const customInput = modal.querySelector('#commentLimitCustom');
                if (this.value === 'custom') {
                    customInput.classList.remove('hidden');
                    customInput.value = defaultMaxComments;
                    customInput.focus();
                } else {
                    customInput.classList.add('hidden');
                }
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // ç¡®è®¤è·å–è¯„è®º
        function confirmCommentFetch(modal) {
            const videoId = modal._videoId;
            const buttonElement = modal._buttonElement;
            
            const selectedOption = modal.querySelector('input[name="commentOption"]:checked').value;
            let maxComments = null;
            
            if (selectedOption === 'limited') {
                const select = modal.querySelector('#commentLimitSelect');
                const customInput = modal.querySelector('#commentLimitCustom');
                
                if (select.value === 'custom') {
                    maxComments = parseInt(customInput.value);
                } else {
                    maxComments = parseInt(select.value);
                }
                
                if (!maxComments || maxComments < 1) {
                    showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„è¯„è®ºæ•°é‡', 'warning');
                    return;
                }
            }
            
            modal.remove();
            fetchCommentsForVideo(videoId, buttonElement, maxComments);
        }
        
        async function fetchCommentsForVideo(videoId, buttonElement = null, maxComments = null) {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                let button = buttonElement;
                if (!button) {
                    // å¦‚æœæ²¡æœ‰ä¼ å…¥æŒ‰é’®å…ƒç´ ï¼Œå°è¯•é€šè¿‡videoIdæ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®
                    button = document.querySelector(`button[onclick*="${videoId}"]`);
                }
                
                if (button) {
                    const originalText = button.textContent;
                    button.textContent = 'è·å–ä¸­...';
                    button.disabled = true;
                }
                
                // è·å–è§†é¢‘çš„å®é™…è¯„è®ºæ€»æ•°
                const statsResponse = await fetch(
                    `https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${videoId}&key=${apiKey}`
                );
                
                if (!statsResponse.ok) {
                    throw new Error(`è·å–è§†é¢‘ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ${statsResponse.status}`);
                }
                
                const statsData = await statsResponse.json();
                const totalCommentCount = parseInt(statsData.items?.[0]?.statistics?.commentCount || 0);
                
                if (totalCommentCount === 0) {
                    if (button) {
                        button.textContent = 'æ— è¯„è®º';
                        button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        button.classList.add('bg-gray-600');
                    }
                    showNotification('è¯¥è§†é¢‘æš‚æ— è¯„è®º', 'info');
                    return;
                }
                
                // åˆ†é¡µè·å–è¯„è®ºï¼Œåº”ç”¨æœ€å¤§è¯„è®ºæ•°é™åˆ¶
                let allComments = [];
                let nextPageToken = null;
                let pageCount = 0;
                const maxResultsPerPage = 100; // YouTube APIæ¯é¡µæœ€å¤§100æ¡
                
                // ç¡®å®šæœ€å¤§è¯„è®ºæ•°é™åˆ¶
                const commentLimit = maxComments !== null ? maxComments : 
                                    (parseInt(document.getElementById('defaultMaxComments')?.value) || 
                                     config.api?.maxCommentsPerVideo || 
                                     null);
                
                // è®¡ç®—å®é™…è¦è·å–çš„æœ€å¤§è¯„è®ºæ•°
                const effectiveLimit = commentLimit ? Math.min(totalCommentCount, commentLimit) : totalCommentCount;
                
                // åªåœ¨ç”¨æˆ·æ˜ç¡®é€‰æ‹©é™åˆ¶æ—¶æ‰æ˜¾ç¤ºæç¤º
                if (maxComments !== null && commentLimit && commentLimit < totalCommentCount) {
                    showNotification(`å°†è·å–å‰ ${formatNumber(effectiveLimit)} æ¡è¯„è®ºï¼ˆå…± ${formatNumber(totalCommentCount)} æ¡ï¼‰`, 'info');
                }
                
                do {
                    pageCount++;
                    if (button) {
                        const currentCount = allComments.length;
                        const remaining = effectiveLimit - currentCount;
                        button.textContent = `è·å–ä¸­... ${currentCount}/${effectiveLimit}`;
                    }
                    
                    // è®¡ç®—æœ¬é¡µè¦è·å–çš„æ•°é‡
                    const remainingToFetch = effectiveLimit - allComments.length;
                    const currentPageMaxResults = remainingToFetch > 0 ? Math.min(maxResultsPerPage, remainingToFetch) : maxResultsPerPage;
                    
                    // æ„å»ºAPIè¯·æ±‚URL - æ·»åŠ replieséƒ¨åˆ†æ¥è·å–å›å¤ä¿¡æ¯
                    let url = `https://www.googleapis.com/youtube/v3/commentThreads?part=snippet,replies&videoId=${videoId}&maxResults=${currentPageMaxResults}&key=${apiKey}`;
                    if (nextPageToken) {
                        url += `&pageToken=${nextPageToken}`;
                    }
                    
                    // å¦‚æœå·²ç»è¾¾åˆ°é™åˆ¶ï¼Œåœæ­¢è·å–
                    if (allComments.length >= effectiveLimit) {
                        break;
                    }
                    
                    // æ·»åŠ è¶…æ—¶å’Œé‡è¯•æœºåˆ¶
                    let response;
                    let retryCount = 0;
                    const maxRetries = 3;
                    
                    while (retryCount < maxRetries) {
                        try {
                            // åˆ›å»ºAbortControllerç”¨äºè¶…æ—¶æ§åˆ¶
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ—¶
                            
                            response = await fetch(url, {
                                signal: controller.signal
                            });
                            
                            clearTimeout(timeoutId);
                            
                            if (!response.ok) {
                                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                            }
                            
                            break; // æˆåŠŸè·å–ï¼Œè·³å‡ºé‡è¯•å¾ªç¯
                            
                        } catch (fetchError) {
                            retryCount++;
                            console.warn(`ç¬¬${retryCount}æ¬¡è¯·æ±‚å¤±è´¥:`, fetchError);
                            
                            if (retryCount >= maxRetries) {
                                throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œå·²é‡è¯•${maxRetries}æ¬¡: ${fetchError.message}`);
                            }
                            
                            // ç­‰å¾…åé‡è¯•
                            await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                        }
                    }
                    
                    const data = await response.json();
                    const pageComments = data.items || [];
                    
                    // å¤„ç†æ¯ä¸ªä¸»è¯„è®ºåŠå…¶å›å¤
                    for (const commentThread of pageComments) {
                        // æ£€æŸ¥æ˜¯å¦å·²è¾¾åˆ°é™åˆ¶
                        if (allComments.length >= effectiveLimit) {
                            break;
                        }
                        
                        // æ·»åŠ ä¸»è¯„è®º
                        allComments.push(commentThread);
                        
                        // æ£€æŸ¥æ˜¯å¦å·²è¾¾åˆ°é™åˆ¶ï¼ˆä¸»è¯„è®ºåï¼‰
                        if (allComments.length >= effectiveLimit) {
                            break;
                        }
                        
                        // è·å–å›å¤è¯„è®ºï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                        if (commentThread.replies && commentThread.replies.comments) {
                            console.log(`å‘ç°å›å¤è¯„è®ºï¼Œæ•°é‡: ${commentThread.replies.comments.length}`);
                            
                            // è·å–å›å¤è¯„è®ºçš„è¯¦ç»†ä¿¡æ¯
                            const replyIds = commentThread.replies.comments.map(reply => reply.id);
                            if (replyIds.length > 0) {
                                try {
                                    console.log(`å‡†å¤‡è·å–å›å¤è¯„è®ºï¼ŒID: ${replyIds.join(',')}`);
                                    
                                    // ä¸ºå›å¤è¯„è®ºAPIè°ƒç”¨æ·»åŠ é‡è¯•æœºåˆ¶
                                    let repliesResponse;
                                    let replyRetryCount = 0;
                                    const maxReplyRetries = 2;
                                    
                                    while (replyRetryCount < maxReplyRetries) {
                                        try {
                                            const controller = new AbortController();
                                            const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ç§’è¶…æ—¶
                                            
                                            const replyUrl = `https://www.googleapis.com/youtube/v3/comments?part=snippet&id=${replyIds.join(',')}&key=${apiKey}`;
                                            console.log(`è¯·æ±‚å›å¤è¯„è®ºURL: ${replyUrl}`);
                                            
                                            repliesResponse = await fetch(replyUrl, {
                                                signal: controller.signal
                                            });
                                            
                                            clearTimeout(timeoutId);
                                            
                                            if (repliesResponse.ok) {
                                                const repliesData = await repliesResponse.json();
                                                console.log(`å›å¤è¯„è®ºAPIå“åº”:`, repliesData);
                                                
                                                if (repliesData.items) {
                                                    // å°†å›å¤è¯„è®ºæ·»åŠ åˆ°ä¸»è¯„è®ºçš„repliesä¸­
                                                    commentThread.replies.comments = repliesData.items;
                                                    console.log(`æˆåŠŸæ·»åŠ å›å¤è¯„è®ºåˆ°ä¸»è¯„è®º:`, commentThread.replies.comments);
                                                    
                                                    // å…³é”®ä¿®å¤ï¼šå°†å›å¤è¯„è®ºä¹Ÿæ·»åŠ åˆ°allCommentsæ•°ç»„ä¸­ï¼Œä½œä¸ºç‹¬ç«‹è¯„è®º
                                                    for (const reply of repliesData.items) {
                                                        // ä¸ºå›å¤è¯„è®ºæ·»åŠ æ ‡è¯†ï¼Œè¡¨æ˜å®ƒæ˜¯å›å¤
                                                        reply.isReply = true;
                                                        reply.parentCommentId = commentThread.id;
                                                        reply.videoTitle = commentThread.snippet?.videoTitle;
                                                        reply.channelTitle = commentThread.snippet?.channelTitle;
                                                        
                                                        // ç¡®ä¿å›å¤è¯„è®ºæœ‰æ­£ç¡®çš„æ–‡æœ¬å†…å®¹
                                                        if (!reply.snippet?.textDisplay && !reply.snippet?.textOriginal) {
                                                            console.warn(`å›å¤è¯„è®º ${reply.id} ç¼ºå°‘æ–‡æœ¬å†…å®¹:`, reply);
                                                        }
                                                        
                                                        // å°†å›å¤è¯„è®ºæ·»åŠ åˆ°ä¸»æ•°ç»„ä¸­
                                                        allComments.push(reply);
                                                        
                                                        // æ£€æŸ¥æ˜¯å¦å·²è¾¾åˆ°é™åˆ¶
                                                        if (allComments.length >= effectiveLimit) {
                                                            break;
                                                        }
                                                        
                                                        console.log(`å·²å°†å›å¤è¯„è®ºæ·»åŠ åˆ°ä¸»æ•°ç»„:`, reply.id, `æ–‡æœ¬:`, reply.snippet?.textDisplay || reply.snippet?.textOriginal || 'æ— å†…å®¹');
                                                    }
                                                    
                                                    // æ£€æŸ¥æ˜¯å¦å·²è¾¾åˆ°é™åˆ¶ï¼ˆå›å¤è¯„è®ºå¾ªç¯åï¼‰
                                                    if (allComments.length >= effectiveLimit) {
                                                        break;
                                                    }
                                                }
                                            } else {
                                                console.warn(`å›å¤è¯„è®ºAPIè¯·æ±‚å¤±è´¥: ${repliesResponse.status}`);
                                            }
                                            break; // æˆåŠŸè·å–ï¼Œè·³å‡ºé‡è¯•å¾ªç¯
                                            
                                        } catch (replyFetchError) {
                                            replyRetryCount++;
                                            console.warn(`è·å–å›å¤è¯„è®ºç¬¬${replyRetryCount}æ¬¡å¤±è´¥:`, replyFetchError);
                                            
                                            if (replyRetryCount >= maxReplyRetries) {
                                                throw replyFetchError;
                                            }
                                            
                                            // ç­‰å¾…åé‡è¯•
                                            await new Promise(resolve => setTimeout(resolve, 500 * replyRetryCount));
                                        }
                                    }
                                    
                                    // æ·»åŠ å»¶è¿Ÿé¿å…APIé™åˆ¶
                                    await new Promise(resolve => setTimeout(resolve, 50));
                                } catch (replyError) {
                                    console.warn('è·å–å›å¤è¯„è®ºå¤±è´¥:', replyError);
                                }
                            }
                        } else {
                            console.log(`ä¸»è¯„è®º ${commentThread.id} æ²¡æœ‰å›å¤`);
                        }
                    }
                    
                    // æ˜¾ç¤ºè¿›åº¦
                    if (button) {
                        const currentCount = allComments.length;
                        button.textContent = `å·²è·å–${currentCount}/${effectiveLimit}æ¡...`;
                    }
                    
                    // å¦‚æœå·²ç»è¾¾åˆ°é™åˆ¶ï¼Œåœæ­¢è·å–
                    if (allComments.length >= effectiveLimit) {
                        break;
                    }
                    
                    // é¿å…APIé™åˆ¶ï¼Œæ·»åŠ å»¶è¿Ÿ
                    if (nextPageToken) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                } while (nextPageToken && allComments.length < effectiveLimit);
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€ - ç§»é™¤è¿™éƒ¨åˆ†ï¼Œå› ä¸ºåé¢ä¼šé‡æ–°è®¾ç½®
                
                // å°†è¯„è®ºå­˜å‚¨åˆ°æœ¬åœ°ï¼Œä¾›åç»­å¯¼å‡ºä½¿ç”¨
                if (!commentManager.comments.has(videoId)) {
                    commentManager.comments.set(videoId, []);
                }
                // æ¸…ç©ºä¹‹å‰çš„è¯„è®ºï¼Œæ·»åŠ æ–°çš„è¯„è®º
                commentManager.comments.set(videoId, allComments);
                console.log(`å·²å­˜å‚¨ ${allComments.length} æ¡è¯„è®ºåˆ° commentManagerï¼Œè§†é¢‘ID: ${videoId}`);
                
                // è®¡ç®—å®é™…è·å–çš„è¯„è®ºæ€»æ•°ï¼ˆä¸»è¯„è®º + å›å¤è¯„è®ºï¼‰
                let actualTotalComments = 0;
                let mainCommentCount = 0;
                let replyCommentCount = 0;
                
                // ç°åœ¨ allComments åŒ…å«ä¸»è¯„è®ºå’Œå›å¤è¯„è®ºçš„æ··åˆæ•°ç»„
                for (const comment of allComments) {
                    if (comment.isReply) {
                        // è¿™æ˜¯å›å¤è¯„è®º
                        replyCommentCount++;
                        actualTotalComments++;
                        console.log(`å›å¤è¯„è®º: ${comment.id}`);
                    } else {
                        // è¿™æ˜¯ä¸»è¯„è®º
                        mainCommentCount++;
                        actualTotalComments++;
                        console.log(`ä¸»è¯„è®º: ${comment.id}`);
                    }
                }
                
                console.log(`è¯„è®ºç»Ÿè®¡è¯¦æƒ…: ä¸»è¯„è®º ${mainCommentCount} æ¡, å›å¤è¯„è®º ${replyCommentCount} æ¡, æ€»è®¡ ${actualTotalComments} æ¡`);
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                if (actualTotalComments === effectiveLimit) {
                    if (effectiveLimit === totalCommentCount) {
                        showNotification(`æˆåŠŸè·å–å…¨éƒ¨ ${actualTotalComments} æ¡è¯„è®ºï¼`, 'success');
                    } else {
                        showNotification(`æˆåŠŸè·å– ${actualTotalComments} æ¡è¯„è®ºï¼ˆé™åˆ¶ï¼š${effectiveLimit}æ¡ï¼‰`, 'success');
                    }
                } else if (actualTotalComments === totalCommentCount) {
                    showNotification(`æˆåŠŸè·å–å…¨éƒ¨ ${actualTotalComments} æ¡è¯„è®ºï¼`, 'success');
                } else {
                    showNotification(`æˆåŠŸè·å– ${actualTotalComments} æ¡è¯„è®ºï¼ˆæ€»è®¡ ${totalCommentCount} æ¡ï¼Œå¯èƒ½å—APIé™åˆ¶ï¼‰`, 'success');
                }
                
                // åœ¨æ§åˆ¶å°æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼Œä¾¿äºéªŒè¯
                console.log(`è§†é¢‘ ${videoId} è¯„è®ºè·å–å®Œæˆ:`);
                console.log(`- æ€»è¯„è®ºæ•°: ${totalCommentCount}`);
                console.log(`- ä¸»è¯„è®ºæ•°: ${mainCommentCount}`);
                console.log(`- å›å¤è¯„è®ºæ•°: ${replyCommentCount}`);
                console.log(`- å®é™…è·å–æ€»æ•°: ${actualTotalComments}`);
                console.log(`- åˆ†é¡µæ•°: ${pageCount}`);
                console.log(`- è¯„è®ºæ•°æ®ç»“æ„:`, allComments.map(comment => {
                    if (comment.isReply) {
                        // å›å¤è¯„è®ºçš„æ•°æ®ç»“æ„
                        return {
                            id: comment.id,
                            text: comment.snippet?.textDisplay || comment.snippet?.textOriginal || comment.text || 'æ— å†…å®¹',
                            hasReplies: false,
                            replyCount: 0
                        };
                    } else {
                        // ä¸»è¯„è®ºçš„æ•°æ®ç»“æ„
                        return {
                            id: comment.id,
                            text: comment.snippet?.topLevelComment?.snippet?.textDisplay?.substring(0, 50) + '...',
                            hasReplies: !!(comment.replies && comment.replies.comments),
                            replyCount: comment.replies?.comments?.length || 0
                        };
                    }
                }));
                
                // æ›´æ–°æŒ‰é’®æ˜¾ç¤ºï¼ŒåŒ…å«éªŒè¯ä¿¡æ¯
                if (button) {
                    if (actualTotalComments === effectiveLimit) {
                        if (effectiveLimit === totalCommentCount) {
                            button.textContent = `å·²è·å–å…¨éƒ¨${actualTotalComments}æ¡`;
                        } else {
                            button.textContent = `å·²è·å–${actualTotalComments}/${effectiveLimit}æ¡`;
                        }
                    } else if (actualTotalComments === totalCommentCount) {
                        button.textContent = `å·²è·å–å…¨éƒ¨${actualTotalComments}æ¡`;
                    } else {
                        button.textContent = `å·²è·å–${actualTotalComments}/${totalCommentCount}æ¡`;
                    }
                }
                
            } catch (error) {
                console.error('Fetch comments error:', error);
                if (button) {
                    button.textContent = 'é‡è¯•';
                    button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    button.classList.add('bg-red-600');
                }
                showNotification('è·å–è¯„è®ºå¤±è´¥: ' + error.message, 'error');
            } finally {
                if (button && typeof button !== 'undefined') {
                    button.disabled = false;
                    // å¦‚æœæŒ‰é’®è¿˜åœ¨"è·å–ä¸­"çŠ¶æ€ï¼Œé‡ç½®ä¸ºæ­£å¸¸çŠ¶æ€
                    if (button.textContent && button.textContent.includes('è·å–ä¸­')) {
                        button.textContent = 'è·å–è¯„è®º';
                        button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }
                }
            }
        }
        

        

        

        

        

        

        

        
        // History
        function loadHistory() {
            // Top searches
            const topSearches = historyManager.getTopSearches(7, 5);
            const searchesContainer = document.getElementById('topSearches');
            searchesContainer.innerHTML = topSearches.map(s => `
                <div class="flex justify-between text-xs p-2 hover:bg-white/5 rounded cursor-pointer" 
                     onclick="performSearchFromHistory('${s.query}')">
                    <span>${s.query}</span>
                    <span class="text-white/60">${s.count}æ¬¡</span>
                    </div>
            `).join('');
            
            // Recent views
            const recentViews = historyManager.getRecentViews(5);
            const viewsContainer = document.getElementById('recentViews');
            viewsContainer.innerHTML = recentViews.map(v => {
                const videoId = v.videoId || v.id;
                console.log('Recent view item:', v); // è°ƒè¯•ä¿¡æ¯
                return `
                    <div class="text-xs p-2 hover:bg-white/5 rounded cursor-pointer" 
                         onclick="copyVideoUrl('${videoId}')">
                        <div class="truncate">${v.title}</div>
                        <div class="text-white/60">${new Date(v.timestamp).toLocaleDateString()}</div>
                        <div class="text-xs text-white/40">ID: ${videoId}</div>
                        </div>
                `;
            }).join('');
            
            // Activity chart
            const stats = historyManager.getActivityStats(7);
            const ctx = document.getElementById('activityChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(stats.daily),
                    datasets: [{
                        label: 'æ´»åŠ¨',
                        data: Object.values(stats.daily),
                        backgroundColor: '#ef4444'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
            
            // History list
            const allHistory = [
                ...historyManager.searchHistory.slice(0, 10).map(h => ({...h, type: 'search'})),
                ...historyManager.viewHistory.slice(0, 10).map(h => ({...h, type: 'view'}))
            ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            const listContainer = document.getElementById('historyList');
            listContainer.innerHTML = allHistory.map(h => {
                if (h.type === 'search') {
                    return `
                        <div class="flex items-center justify-between text-xs p-2 hover:bg-white/5 rounded cursor-pointer" 
                             onclick="performSearchFromHistory('${h.query}')">
                            <div class="flex items-center gap-2">
                                <i data-lucide="search" class="w-3 h-3"></i>
                                <span>${h.query}</span>
                </div>
                            <div class="flex items-center gap-2">
                                <span class="text-white/40">${new Date(h.timestamp).toLocaleString()}</span>
                                <span class="text-blue-400 text-xs">ç‚¹å‡»é‡æ–°æœç´¢</span>
            </div>
            </div>
                    `;
                } else {
                    const videoId = h.videoId || h.id;
                    console.log('View history item:', h); // è°ƒè¯•ä¿¡æ¯
                    return `
                        <div class="flex items-center justify-between text-xs p-2 hover:bg-white/5 rounded cursor-pointer" 
                             onclick="copyVideoUrl('${videoId}')">
                            <div class="flex items-center gap-2">
                                <i data-lucide="play" class="w-3 h-3"></i>
                                <span>${h.title}</span>
        </div>
                            <div class="flex items-center gap-2">
                                <span class="text-white/40">${new Date(h.timestamp).toLocaleString()}</span>
                                <span class="text-green-400 text-xs">ç‚¹å‡»å¤åˆ¶URL</span>
                                <span class="text-white/40 text-xs">ID: ${videoId}</span>
    </div>
                        </div>
                    `;
                }
            }).join('');
            
            lucide.createIcons();
        }
        
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                historyManager.clearHistory('all');
                loadHistory();
            }
        }
        
        // History actions
        function performSearchFromHistory(query) {
            // åˆ‡æ¢åˆ°æœç´¢æ ‡ç­¾é¡µ
            switchTab('search');
            // è®¾ç½®æœç´¢è¾“å…¥æ¡†çš„å€¼
            document.getElementById('searchInput').value = query;
            // æ‰§è¡Œæœç´¢
            performSearch();
        }
        
        function copyVideoUrl(videoId) {
            // æ£€æŸ¥videoIdæ˜¯å¦æœ‰æ•ˆ
            if (!videoId || videoId === 'undefined' || videoId === 'null') {
                console.error('Invalid videoId:', videoId);
                showNotification('æ— æ³•å¤åˆ¶URLï¼šè§†é¢‘IDæ— æ•ˆ', 'error');
                return;
            }
            
            const url = `https://www.youtube.com/watch?v=${videoId}`;
            console.log('Copying URL:', url); // è°ƒè¯•ä¿¡æ¯
            
            copyToClipboard(url).then((success) => {
                if (success) {
                    showNotification('è§†é¢‘URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                } else {
                    showNotification('è¯·æ‰‹åŠ¨å¤åˆ¶æ˜¾ç¤ºçš„æ–‡æœ¬', 'warning');
                }
            }).catch(() => {
                showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }
        
        function openVideo(videoId) {
            // æ£€æŸ¥videoIdæ˜¯å¦æœ‰æ•ˆ
            if (!videoId || videoId === 'undefined' || videoId === 'null') {
                console.error('Invalid videoId:', videoId);
                showNotification('æ— æ³•æ‰“å¼€è§†é¢‘ï¼šè§†é¢‘IDæ— æ•ˆ', 'error');
                return;
            }
            
            const url = `https://www.youtube.com/watch?v=${videoId}`;
            console.log('Opening video:', url); // è°ƒè¯•ä¿¡æ¯
            
            // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€è§†é¢‘
            window.open(url, '_blank');
        }
        
        // Search results management
        function updateSearchResultsStats(items) {
            if (!items || items.length === 0) {
                document.getElementById('searchResultsStats').classList.add('hidden');
                return;
            }
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('searchResultsCount').textContent = items.length;
            document.getElementById('selectedCount').textContent = selectedVideos.size;
            
            // è®¡ç®—æ€»è§‚çœ‹æ•°å’Œç‚¹èµæ•°
            const totalViews = items.reduce((sum, item) => sum + (parseInt(item.statistics?.viewCount || 0)), 0);
            const totalLikes = items.reduce((sum, item) => sum + (parseInt(item.statistics?.likeCount || 0)), 0);
            
            document.getElementById('totalViews').textContent = formatNumber(totalViews);
            document.getElementById('totalLikes').textContent = formatNumber(totalLikes);
        }
        
        function toggleVideoSelection(videoId) {
            if (selectedVideos.has(videoId)) {
                selectedVideos.delete(videoId);
            } else {
                selectedVideos.add(videoId);
            }
            updateSearchResultsStats(Array.from(document.querySelectorAll('#searchResults .glass-card')).map(card => {
                // ä»DOMä¸­æå–è§†é¢‘æ•°æ®
                const videoId = card.querySelector('input[type="checkbox"]').onchange.toString().match(/'([^']+)'/)[1];
                const title = card.querySelector('h3').textContent;
                const channel = card.querySelector('p').textContent;
                const stats = card.querySelectorAll('.flex.justify-between span');
                const views = parseInt(stats[0].textContent.replace(/[^\d]/g, ''));
                const likes = parseInt(stats[1].textContent.replace(/[^\d]/g, ''));
                const comments = parseInt(stats[2].textContent.replace(/[^\d]/g, ''));
                
                return {
                    id: videoId,
                    snippet: { title, channelTitle: channel },
                    statistics: { viewCount: views, likeCount: likes, commentCount: comments }
                };
            }));
        }
        
        function selectAll() {
            const checkboxes = document.querySelectorAll('#searchResults input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const videoId = checkbox.onchange.toString().match(/'([^']+)'/)[1];
                selectedVideos.add(videoId);
            });
            updateSearchResultsStats(Array.from(document.querySelectorAll('#searchResults .glass-card')).map(card => {
                const videoId = card.querySelector('input[type="checkbox"]').onchange.toString().match(/'([^']+)'/)[1];
                const title = card.querySelector('h3').textContent;
                const channel = card.querySelector('p').textContent;
                const stats = card.querySelectorAll('.flex.justify-between span');
                const views = parseInt(stats[0].textContent.replace(/[^\d]/g, ''));
                const likes = parseInt(stats[1].textContent.replace(/[^\d]/g, ''));
                const comments = parseInt(stats[2].textContent.replace(/[^\d]/g, ''));
                
                return {
                    id: videoId,
                    snippet: { title, channelTitle: channel },
                    statistics: { viewCount: views, likeCount: likes, commentCount: comments }
                };
            }));
        }
        
        function deselectAll() {
            const checkboxes = document.querySelectorAll('#searchResults input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            selectedVideos.clear();
            updateSearchResultsStats(Array.from(document.querySelectorAll('#searchResults .glass-card')).map(card => {
                const videoId = card.querySelector('input[type="checkbox"]').onchange.toString().match(/'([^']+)'/)[1];
                const title = card.querySelector('h3').textContent;
                const channel = card.querySelector('p').textContent;
                const stats = card.querySelectorAll('.flex.justify-between span');
                const views = parseInt(stats[0].textContent.replace(/[^\d]/g, ''));
                const likes = parseInt(stats[1].textContent.replace(/[^\d]/g, ''));
                const comments = parseInt(stats[2].textContent.replace(/[^\d]/g, ''));
                
                return {
                    id: videoId,
                    snippet: { title, channelTitle: channel },
                    statistics: { viewCount: views, likeCount: likes, commentCount: comments }
                };
            }));
        }
        
        // é€šç”¨çš„å¤åˆ¶åˆ°å‰ªè´´æ¿å‡½æ•°ï¼ˆå¸¦å…¼å®¹æ€§æ£€æŸ¥ï¼‰
        function copyToClipboard(text) {
            // æ£€æŸ¥æ˜¯å¦æ”¯æŒç°ä»£ Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text).then(() => {
                    return true;
                }).catch(() => {
                    // é™çº§åˆ°ä¼ ç»Ÿæ–¹æ³•
                    return fallbackCopyToClipboard(text);
                });
            } else {
                // ä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                return Promise.resolve(fallbackCopyToClipboard(text));
            }
        }
        
        // é™çº§å¤åˆ¶æ–¹æ¡ˆï¼ˆå…¼å®¹æ‰€æœ‰æµè§ˆå™¨ï¼‰
        function fallbackCopyToClipboard(text) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    return true;
                } else {
                    throw new Error('execCommand failed');
                }
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                // æœ€åçš„é™çº§æ–¹æ¡ˆï¼šæ˜¾ç¤ºæ–‡æœ¬è®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '50%';
                textArea.style.top = '50%';
                textArea.style.transform = 'translate(-50%, -50%)';
                textArea.style.width = '80%';
                textArea.style.height = '200px';
                textArea.style.zIndex = '9999';
                document.body.appendChild(textArea);
                textArea.select();
                
                setTimeout(() => {
                    document.body.removeChild(textArea);
                }, 3000);
                
                return false;
            }
        }
        
        function copySelectedUrls() {
            if (selectedVideos.size === 0) {
                showNotification('è¯·å…ˆé€‰æ‹©è§†é¢‘', 'warning');
                return;
            }
            
            const urls = Array.from(selectedVideos).map(videoId => 
                `https://www.youtube.com/watch?v=${videoId}`
            ).join('\n');
            
            copyToClipboard(urls).then((success) => {
                if (success) {
                    showNotification('URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                } else {
                    showNotification('è¯·æ‰‹åŠ¨å¤åˆ¶æ˜¾ç¤ºçš„æ–‡æœ¬', 'warning');
                }
            }).catch(() => {
                showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }
        
        function exportSearchResults() {
            if (selectedVideos.size === 0) {
                showNotification('è¯·å…ˆé€‰æ‹©è§†é¢‘', 'warning');
                return;
            }
            
            const selectedItems = Array.from(document.querySelectorAll('#searchResults .glass-card')).filter(card => {
                const videoId = card.querySelector('input[type="checkbox"]').onchange.toString().match(/'([^']+)'/)[1];
                return selectedVideos.has(videoId);
            }).map(card => {
                const videoId = card.querySelector('input[type="checkbox"]').onchange.toString().match(/'([^']+)'/)[1];
                const title = card.querySelector('h3').textContent;
                const channel = card.querySelector('p').textContent;
                const stats = card.querySelectorAll('.flex.justify-between span');
                const views = parseInt(stats[0].textContent.replace(/[^\d]/g, ''));
                const likes = parseInt(stats[1].textContent.replace(/[^\d]/g, ''));
                const comments = parseInt(stats[2].textContent.replace(/[^\d]/g, ''));
                
                return {
                    id: videoId,
                    title,
                    channel,
                    views,
                    likes,
                    comments,
                    url: `https://www.youtube.com/watch?v=${videoId}`
                };
            });
            
            const json = JSON.stringify(selectedItems, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `youtube-search-results-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            showNotification(`å·²å¯¼å‡º ${selectedItems.length} ä¸ªè§†é¢‘æ•°æ®`, 'success');
        }
        
        function addSelectedToLibrary() {
            if (selectedVideos.size === 0) {
                showNotification('è¯·å…ˆé€‰æ‹©è§†é¢‘', 'warning');
                return;
            }
            
            let addedCount = 0;
            const selectedItems = Array.from(document.querySelectorAll('#searchResults .glass-card')).filter(card => {
                const videoId = card.querySelector('input[type="checkbox"]').onchange.toString().match(/'([^']+)'/)[1];
                return selectedVideos.has(videoId);
            });
            
            selectedItems.forEach(card => {
                const videoId = card.querySelector('input[type="checkbox"]').onchange.toString().match(/'([^']+)'/)[1];
                if (!videos.find(v => v.id === videoId)) {
                    // è¿™é‡Œéœ€è¦è°ƒç”¨addVideoå‡½æ•°ï¼Œä½†ä¸ºäº†é¿å…é‡å¤ä»£ç ï¼Œæˆ‘ä»¬ç›´æ¥æ·»åŠ åˆ°videosæ•°ç»„
                    const title = card.querySelector('h3').textContent;
                    const channel = card.querySelector('p').textContent;
                    const stats = card.querySelectorAll('.flex.justify-between span');
                    const views = parseInt(stats[0].textContent.replace(/[^\d]/g, ''));
                    const likes = parseInt(stats[1].textContent.replace(/[^\d]/g, ''));
                    const comments = parseInt(stats[2].textContent.replace(/[^\d]/g, ''));
                    
                    videos.push({
                        id: videoId,
                        title,
                        channel,
                        views,
                        likes,
                        comments,
                        url: `https://www.youtube.com/watch?v=${videoId}`
                    });
                    addedCount++;
                }
            });
            
            if (addedCount > 0) {
                saveVideos();
                showNotification(`æˆåŠŸæ·»åŠ  ${addedCount} ä¸ªè§†é¢‘åˆ°åº“`, 'success');
            } else {
                showNotification('æ‰€æœ‰é€‰ä¸­çš„è§†é¢‘éƒ½å·²å­˜åœ¨äºåº“ä¸­', 'info');
            }
        }
        
        async function exportComments() {
            if (selectedVideos.size === 0) {
                showNotification('è¯·å…ˆé€‰æ‹©è§†é¢‘', 'warning');
                return;
            }
            
            // æ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹å¯¹è¯æ¡†
            showExportCommentsDialog();
        }
        
        function showExportCommentsDialog() {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center';
            dialog.innerHTML = `
                <div class="panel max-w-md w-full mx-4">
                    <div class="p-6">
                        <h3 class="text-lg font-bold mb-4">å¯¼å‡ºè¯„è®ºé€‰é¡¹</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs text-white/60 mb-2">å¯¼å‡ºæ ¼å¼</label>
                                <select id="exportFormat" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm">
                                    <option value="json">JSONæ ¼å¼</option>
                                    <option value="csv">CSVæ ¼å¼</option>
                                    <option value="txt">çº¯æ–‡æœ¬æ ¼å¼</option>
                                    <option value="html">HTMLæŠ¥å‘Š</option>
                                </select>
                    </div>
                            
                            <div>
                                <label class="block text-xs text-white/60 mb-2">è¯„è®ºæ•°é‡é™åˆ¶</label>
                                <input type="number" id="exportCommentLimit" value="100" min="1" max="1000" 
                                    class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm">
                </div>

                            <div>
                                <label class="block text-xs text-white/60 mb-2">åŒ…å«å†…å®¹</label>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2 text-sm">
                                        <input type="checkbox" id="includeAuthor" checked class="w-4 h-4">
                                        <span>è¯„è®ºè€…ä¿¡æ¯</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-sm">
                                        <input type="checkbox" id="includeTimestamp" checked class="w-4 h-4">
                                        <span>è¯„è®ºæ—¶é—´</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-sm">
                                        <input type="checkbox" id="includeLikes" checked class="w-4 h-4">
                                        <span>ç‚¹èµæ•°</span>
                                    </label>
                                    <label class="block text-xs text-white/60">ï¼ˆå¦‚æœè¯„è®ºå°šæœªè·å–ï¼Œå°†è‡ªåŠ¨è·å–ï¼‰</label>
            </div>
                    </div>
                    </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button onclick="this.closest('.fixed').remove()" 
                                class="flex-1 px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm transition-all">
                                å–æ¶ˆ
                            </button>
                            <button onclick="executeExportComments()" 
                                class="flex-1 btn-gradient text-white rounded-lg py-2 text-sm">
                                å¼€å§‹å¯¼å‡º
                            </button>
                    </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
        }
        
        async function executeExportComments() {
            const dialog = document.querySelector('.fixed');
            const format = document.getElementById('exportFormat').value;
            const limit = parseInt(document.getElementById('exportCommentLimit').value);
            const includeAuthor = document.getElementById('includeAuthor').checked;
            const includeTimestamp = document.getElementById('includeTimestamp').checked;
            const includeLikes = document.getElementById('includeLikes').checked;
            
            dialog.remove();
            
            try {
                // å»æ‰é€šçŸ¥å¼¹çª—ï¼Œç›´æ¥å¼€å§‹å¯¼å‡º
                const selectedVideoIds = Array.from(selectedVideos);
                const allComments = [];
                
                for (const videoId of selectedVideoIds) {
                    // ä» commentManager è·å–å·²å­˜å‚¨çš„è¯„è®ºæ•°æ®
                    const storedComments = commentManager.comments.get(videoId);
                    if (storedComments && storedComments.length > 0) {
                        console.log(`ä» commentManager è·å–åˆ° ${storedComments.length} æ¡è¯„è®ºï¼Œè§†é¢‘ID: ${videoId}`);
                        
                        // è·å–è§†é¢‘ä¿¡æ¯
                        const videoCard = document.querySelector(`#searchResults .glass-card input[onchange*="${videoId}"]`).closest('.glass-card');
                        const videoTitle = videoCard?.querySelector('h3')?.textContent || 'æœªçŸ¥è§†é¢‘';
                        const videoChannel = videoCard?.querySelector('p')?.textContent || 'æœªçŸ¥é¢‘é“';
                        
                        // å¤„ç†å­˜å‚¨çš„è¯„è®ºæ•°æ®
                        storedComments.forEach(comment => {
                            if (comment.isReply) {
                                // å›å¤è¯„è®º
                                const replyData = {
                                    videoId,
                                    videoTitle,
                                    videoChannel,
                                    commentId: comment.id,
                                    text: comment.snippet?.textDisplay || comment.snippet?.textOriginal || comment.text || 'æ— å†…å®¹',
                                    author: comment.snippet?.authorDisplayName || comment.author || 'æœªçŸ¥ç”¨æˆ·',
                                    publishedAt: comment.snippet?.publishedAt || comment.publishedAt || '',
                                    likes: comment.snippet?.likeCount || comment.likes || 0,
                                    isReply: true,
                                    parentCommentId: comment.parentCommentId || ''
                                };
                                allComments.push(replyData);
                            } else {
                                // ä¸»è¯„è®º
                                const mainData = {
                                    videoId,
                                    videoTitle,
                                    videoChannel,
                                    commentId: comment.id,
                                    text: comment.snippet?.topLevelComment?.snippet?.textDisplay || 
                                          comment.snippet?.topLevelComment?.snippet?.textOriginal || 'æ— å†…å®¹',
                                    author: comment.snippet?.topLevelComment?.snippet?.authorDisplayName || 'æœªçŸ¥ç”¨æˆ·',
                                    publishedAt: comment.snippet?.topLevelComment?.snippet?.publishedAt || '',
                                    likes: comment.snippet?.topLevelComment?.snippet?.likeCount || 0,
                                    isReply: false,
                                    replyCount: comment.snippet?.totalReplyCount || 0
                                };
                                allComments.push(mainData);
                            }
                        });
                    } else {
                        console.warn(`è§†é¢‘ ${videoId} æ²¡æœ‰æ‰¾åˆ°å·²å­˜å‚¨çš„è¯„è®ºæ•°æ®ï¼Œè¯·å…ˆè·å–è¯„è®º`);
                    }
                }
                
                if (allComments.length === 0) {
                    showNotification('æ²¡æœ‰æ‰¾åˆ°å¯å¯¼å‡ºçš„è¯„è®º', 'warning');
                    return;
                }
                
                // æ ¹æ®æ ¼å¼å¯¼å‡º
                exportCommentsByFormat(allComments, format);
                
            } catch (error) {
                console.error('Export comments error:', error);
                showNotification('å¯¼å‡ºè¯„è®ºå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // å¤„ç†æ··åˆçš„è¯„è®ºæ•°ç»„ç”¨äºå¯¼å‡ºï¼ˆåŒ…å«ä¸»è¯„è®ºå’Œå›å¤è¯„è®ºï¼‰
        function processCommentsForExport(comments) {
            console.log('å¼€å§‹å¤„ç†è¯„è®ºæ•°æ®ç”¨äºå¯¼å‡ºï¼ŒåŸå§‹æ•°æ®:', comments);
            
            const exportData = [];
            
            comments.forEach((comment, index) => {
                console.log(`å¤„ç†ç¬¬${index + 1}ä¸ªè¯„è®º:`, comment);
                
                try {
                    if (comment.isReply) {
                        // è¿™æ˜¯å›å¤è¯„è®º
                        console.log(`å¤„ç†å›å¤è¯„è®º: ${comment.id}`);
                        console.log(`å›å¤è¯„è®ºå®Œæ•´æ•°æ®ç»“æ„:`, comment);
                        
                        // å°è¯•å¤šç§æ•°æ®è®¿é—®è·¯å¾„æ¥è·å–å›å¤è¯„è®ºçš„æ–‡æœ¬
                        let replyText = 'æ— å†…å®¹';
                        let replyAuthor = 'æœªçŸ¥ä½œè€…';
                        let replyPublishedAt = '';
                        let replyLikes = 0;
                        
                        if (comment.snippet?.textDisplay) {
                            replyText = comment.snippet.textDisplay;
                        } else if (comment.text) {
                            replyText = comment.text;
                        } else if (comment.snippet?.text) {
                            replyText = comment.snippet.text;
                        }
                        
                        if (comment.snippet?.authorDisplayName) {
                            replyAuthor = comment.snippet.authorDisplayName;
                        } else if (comment.author) {
                            replyAuthor = comment.author;
                        }
                        
                        if (comment.snippet?.publishedAt) {
                            replyPublishedAt = comment.snippet.publishedAt;
                        } else if (comment.publishedAt) {
                            replyPublishedAt = comment.publishedAt;
                        }
                        
                        if (comment.snippet?.likeCount) {
                            replyLikes = comment.snippet.likeCount;
                        } else if (comment.likes) {
                            replyLikes = comment.likes;
                        }
                        
                        const replyComment = {
                            type: 'å›å¤è¯„è®º',
                            id: comment.id || `reply-${index}`,
                            author: replyAuthor,
                            text: replyText,
                            publishedAt: replyPublishedAt,
                            likes: replyLikes,
                            replyCount: 0,
                            videoTitle: comment.videoTitle || 'æœªçŸ¥è§†é¢‘',
                            channelTitle: comment.channelTitle || 'æœªçŸ¥é¢‘é“',
                            parentCommentId: comment.parentCommentId || 'æœªçŸ¥'
                        };
                        
                        console.log(`å›å¤è¯„è®ºæ•°æ®:`, replyComment);
                        exportData.push(replyComment);
                        
                    } else {
                        // è¿™æ˜¯ä¸»è¯„è®º
                        console.log(`å¤„ç†ä¸»è¯„è®º: ${comment.id}`);
                        
                        const mainComment = {
                            type: 'ä¸»è¯„è®º',
                            id: comment.id || `main-${index}`,
                            author: comment.snippet?.topLevelComment?.snippet?.authorDisplayName || 'æœªçŸ¥ä½œè€…',
                            text: comment.snippet?.topLevelComment?.snippet?.textDisplay || 'æ— å†…å®¹',
                            publishedAt: comment.snippet?.topLevelComment?.snippet?.publishedAt || '',
                            likes: comment.snippet?.topLevelComment?.snippet?.likeCount || 0,
                            replyCount: comment.snippet?.totalReplyCount || 0,
                            videoTitle: comment.snippet?.videoTitle || 'æœªçŸ¥è§†é¢‘',
                            channelTitle: comment.snippet?.channelTitle || 'æœªçŸ¥é¢‘é“'
                        };
                        
                        console.log(`ä¸»è¯„è®ºæ•°æ®:`, mainComment);
                        exportData.push(mainComment);
                    }
                } catch (error) {
                    console.error(`å¤„ç†è¯„è®º ${index} æ—¶å‡ºé”™:`, error);
                    // æ·»åŠ åŸå§‹æ•°æ®ç”¨äºè°ƒè¯•
                    const fallbackComment = {
                        type: 'æœªçŸ¥ç±»å‹',
                        id: `fallback-${index}`,
                        author: 'æœªçŸ¥ä½œè€…',
                        text: 'æ•°æ®è§£æå¤±è´¥',
                        publishedAt: '',
                        likes: 0,
                        replyCount: 0,
                        videoTitle: 'æœªçŸ¥è§†é¢‘',
                        channelTitle: 'æœªçŸ¥é¢‘é“',
                        rawData: JSON.stringify(comment)
                    };
                    exportData.push(fallbackComment);
                }
            });
            
            console.log(`è¯„è®ºå¤„ç†å®Œæˆ: æ€»è¯„è®º ${exportData.length} æ¡`);
            console.log(`å¤„ç†åçš„æ•°æ®:`, exportData);
            return exportData;
        }
        
        function exportCommentsByFormat(comments, format) {
            console.log('å¼€å§‹å¯¼å‡ºè¯„è®ºï¼Œæ ¼å¼:', format, 'è¯„è®ºæ•°æ®:', comments);
            
            let content, filename, mimeType;
            
            switch (format) {
                case 'json':
                    content = JSON.stringify(comments, null, 2);
                    filename = `youtube-comments-${new Date().toISOString().split('T')[0]}.json`;
                    mimeType = 'application/json';
                    break;
                    
                case 'csv':
                    if (comments.length > 0) {
                        const headers = ['è§†é¢‘ID', 'è¯„è®ºID', 'ä½œè€…', 'å†…å®¹', 'å‘å¸ƒæ—¶é—´', 'ç‚¹èµæ•°', 'å›å¤æ•°', 'è§†é¢‘æ ‡é¢˜', 'é¢‘é“åç§°', 'ç±»å‹'];
                        const rows = comments.map(comment => [
                            comment.videoId,
                            comment.commentId,
                            comment.author,
                            comment.text,
                            comment.publishedAt,
                            comment.likes,
                            comment.isReply ? '' : comment.replyCount,
                            comment.videoTitle,
                            comment.videoChannel,
                            comment.isReply ? 'å›å¤è¯„è®º' : 'ä¸»è¯„è®º'
                        ].map(value => 
                            typeof value === 'string' ? `"${value.replace(/"/g, '""')}"` : value
                        ).join(','));
                        content = [headers.join(','), ...rows].join('\n');
                    } else {
                        content = 'è§†é¢‘ID,è¯„è®ºID,ä½œè€…,å†…å®¹,å‘å¸ƒæ—¶é—´,ç‚¹èµæ•°,å›å¤æ•°,è§†é¢‘æ ‡é¢˜,é¢‘é“åç§°,ç±»å‹\n';
                    }
                    filename = `youtube-comments-${new Date().toISOString().split('T')[0]}.csv`;
                    mimeType = 'text/csv';
                    break;
                    
                case 'txt':
                    content = comments.map(comment => 
                        `è§†é¢‘ID: ${comment.videoId}\nè¯„è®ºID: ${comment.commentId}\nä½œè€…: ${comment.author}\nå†…å®¹: ${comment.text}\nå‘å¸ƒæ—¶é—´: ${comment.publishedAt}\nç‚¹èµæ•°: ${comment.likes}\nå›å¤æ•°: ${comment.isReply ? '' : comment.replyCount}\nè§†é¢‘æ ‡é¢˜: ${comment.videoTitle}\né¢‘é“åç§°: ${comment.videoChannel}\nç±»å‹: ${comment.isReply ? 'å›å¤è¯„è®º' : 'ä¸»è¯„è®º'}\n---\n`
                    ).join('\n');
                    filename = `youtube-comments-${new Date().toISOString().split('T')[0]}.txt`;
                    mimeType = 'text/plain';
                    break;
                    
                case 'html':
                    content = generateCommentsHTML(comments);
                    filename = `youtube-comments-${new Date().toISOString().split('T')[0]}.html`;
                    mimeType = 'text/html';
                    break;
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            
            showNotification(`æˆåŠŸå¯¼å‡º ${comments.length} æ¡è¯„è®º (${format.toUpperCase()})`, 'success');
        }
        
        function generateCommentsHTML(comments) {
            const videoGroups = {};
            comments.forEach(comment => {
                if (!videoGroups[comment.videoTitle]) {
                    videoGroups[comment.videoTitle] = {
                        title: comment.videoTitle,
                        channel: comment.videoChannel,
                        mainComments: [],
                        replyComments: []
                    };
                }
                
                if (comment.isReply) {
                    videoGroups[comment.videoTitle].replyComments.push(comment);
                } else {
                    videoGroups[comment.videoTitle].mainComments.push(comment);
                }
            });
            
            return `
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTubeè¯„è®ºå¯¼å‡ºæŠ¥å‘Š</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .video-section { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .video-title { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 10px; }
        .video-channel { color: #666; margin-bottom: 20px; }
        .comment { border-left: 3px solid #e0e0e0; padding: 15px; margin-bottom: 15px; background: #fafafa; }
        .main-comment { border-left: 3px solid #2196F3; }
        .reply-comment { border-left: 3px solid #FF9800; margin-left: 30px; }
        .comment-text { font-size: 16px; line-height: 1.5; margin-bottom: 10px; }
        .comment-meta { font-size: 14px; color: #666; }
        .comment-type { font-size: 12px; color: #fff; padding: 2px 8px; border-radius: 12px; margin-bottom: 8px; display: inline-block; }
        .type-main { background: #2196F3; }
        .type-reply { background: #FF9800; }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat { text-align: center; }
        .stat-number { font-size: 32px; font-weight: bold; color: #2196F3; }
        .stat-label { color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>YouTubeè¯„è®ºå¯¼å‡ºæŠ¥å‘Š</h1>
            <p>å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}</p>
            <div class="stats">
                <div class="stat">
                    <div class="stat-number">${Object.keys(videoGroups).length}</div>
                    <div class="stat-label">è§†é¢‘æ•°é‡</div>
                </div>
                <div class="stat">
                    <div class="stat-number">${comments.length}</div>
                    <div class="stat-label">è¯„è®ºæ€»æ•°</div>
            </div>
                                <div class="stat">
                    <div class="stat-number">${comments.filter(c => !c.isReply).length}</div>
                    <div class="stat-label">ä¸»è¯„è®º</div>
                </div>
                <div class="stat">
                    <div class="stat-number">${comments.filter(c => c.isReply).length}</div>
                    <div class="stat-label">å›å¤è¯„è®º</div>
                </div>
        </div>
    </div>

        ${Object.values(videoGroups).map(group => `
            <div class="video-section">
                <div class="video-title">${group.title}</div>
                <div class="video-channel">é¢‘é“: ${group.channel}</div>
                <div class="comment">
                    <div class="comment-text">å…± ${group.mainComments.length + group.replyComments.length} æ¡è¯„è®º (ä¸»è¯„è®º: ${group.mainComments.length}, å›å¤: ${group.replyComments.length})</div>
            </div>
                
                ${group.mainComments.map(mainComment => `
                    <div class="comment main-comment">
                        <div class="comment-type type-main">ä¸»è¯„è®º</div>
                        <div class="comment-text">${mainComment.text}</div>
                        <div class="comment-meta">
                            ${mainComment.author ? `ä½œè€…: ${mainComment.author} | ` : ''}
                            ${mainComment.publishedAt ? `æ—¶é—´: ${new Date(mainComment.publishedAt).toLocaleString()} | ` : ''}
                            ${mainComment.likes ? `ç‚¹èµ: ${mainComment.likes} | ` : ''}
                            ${mainComment.replyCount ? `å›å¤: ${mainComment.replyCount}` : ''}
                </div>
                        
                        ${group.replyComments.filter(reply => reply.parentCommentId === mainComment.id).map(reply => `
                            <div class="comment reply-comment">
                                <div class="comment-type type-reply">å›å¤</div>
                                <div class="comment-text">${reply.text}</div>
                                <div class="comment-meta">
                                    ${reply.author ? `ä½œè€…: ${reply.author} | ` : ''}
                                    ${reply.publishedAt ? `æ—¶é—´: ${new Date(reply.publishedAt).toLocaleString()} | ` : ''}
                                    ${reply.likes ? `ç‚¹èµ: ${reply.likes}` : ''}
                </div>
                </div>
                        `).join('')}
            </div>
                `).join('')}
        </div>
        `).join('')}
    </div>
</body>
</html>`;
        }
        
        // Filter management
        function resetFilters() {
            // é‡ç½®æ‰€æœ‰ç­›é€‰é€‰é¡¹åˆ°é»˜è®¤å€¼
            document.getElementById('searchOrder').value = 'relevance';
            document.getElementById('videoType').value = 'any';
            document.getElementById('videoDuration').value = 'any';
            document.getElementById('videoDefinition').value = 'any';
            document.getElementById('viewCount').value = 'any';
            document.getElementById('relevanceLanguage').value = 'any';
            document.getElementById('videoCategoryId').value = 'any';
            document.getElementById('regionCode').value = 'any';
            document.getElementById('safeSearch').value = 'moderate';
            document.getElementById('publishedAfter').value = '';
            document.getElementById('publishedBefore').value = '';
            
            // æ›´æ–°ç­›é€‰è®¡æ•°
            updateActiveFiltersCount();
            
            showNotification('ç­›é€‰æ¡ä»¶å·²é‡ç½®', 'info');
        }
        
        function updateActiveFiltersCount() {
            const filters = [
                'searchOrder',
                'videoType', 
                'videoDuration',
                'videoDefinition',
                'viewCount',
                'relevanceLanguage',
                'videoCategoryId',
                'regionCode',
                'safeSearch',
                'publishedAfter',
                'publishedBefore'
            ];
            
            let activeCount = 0;
            filters.forEach(filterId => {
                const element = document.getElementById(filterId);
                if (element && element.value && element.value !== 'any' && element.value !== '' && element.value !== 'moderate') {
                    activeCount++;
                }
            });
            
            document.getElementById('activeFiltersCount').textContent = activeCount;
        }
        
        // Search suggestions
        function updateSearchSuggestions() {
            const suggestions = historyManager.getSearchSuggestions('', 5);
            if (suggestions.length > 0) {
                document.getElementById('searchSuggestions').classList.remove('hidden');
                document.getElementById('suggestionsList').innerHTML = suggestions.map(s => `
                    <button onclick="document.getElementById('searchInput').value='${s}'; performSearch()" 
                        class="px-3 py-1 bg-white/5 hover:bg-white/10 rounded-lg text-xs transition-all">
                        ${s}
                    </button>
                `).join('');
            } else {
                document.getElementById('searchSuggestions').classList.add('hidden');
            }
        }
        
        // Usage Guide
        function toggleUsageGuide() {
            const guide = document.getElementById('usageGuide');
            const toggle = document.getElementById('usageGuideToggle');
            
            if (guide.classList.contains('hidden')) {
                guide.classList.remove('hidden');
                toggle.textContent = 'éšè—ä½¿ç”¨è¯´æ˜';
            } else {
                guide.classList.add('hidden');
                toggle.textContent = 'æ˜¾ç¤ºä½¿ç”¨è¯´æ˜';
            }
        }
        
        // Quick Help
        function showQuickHelp() {
            const helpModal = document.createElement('div');
            helpModal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center';
            helpModal.innerHTML = `
                <div class="panel max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">ğŸš€ YouTube Studio Pro å¿«é€Ÿå¸®åŠ©</h2>
                            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-300 rounded-lg transition-all flex items-center gap-2">
                                <i data-lucide="x" class="w-4 h-4"></i>
                                å…³é—­
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- å¿«é€Ÿå¼€å§‹ -->
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold text-blue-200">âš¡ å¿«é€Ÿå¼€å§‹</h3>
                                <div class="space-y-3">
                                    <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-3">
                                        <h4 class="font-medium text-blue-100">1. é…ç½® API Key</h4>
                                        <p class="text-sm text-white/80">ç‚¹å‡»è®¾ç½®æŒ‰é’®ï¼Œè¾“å…¥ YouTube Data API v3 Key</p>
                                    </div>
                                    <div class="bg-green-500/10 border border-green-500/20 rounded-lg p-3">
                                        <h4 class="font-medium text-green-100">2. æœç´¢è§†é¢‘</h4>
                                        <p class="text-sm text-white/80">è¾“å…¥å…³é”®è¯æˆ–ç²˜è´´è§†é¢‘é“¾æ¥è¿›è¡Œæœç´¢</p>
                                    </div>
                                    <div class="bg-purple-500/10 border border-purple-500/20 rounded-lg p-3">
                                        <h4 class="font-medium text-purple-100">3. è·å–è¯„è®º</h4>
                                        <p class="text-sm text-white/80">ç‚¹å‡»"è·å–è¯„è®º"æŒ‰é’®ä¸‹è½½è¯„è®ºæ•°æ®</p>
                                    </div>
                                    <div class="bg-orange-500/10 border border-orange-500/20 rounded-lg p-3">
                                        <h4 class="font-medium text-orange-100">4. å¯¼å‡ºæ•°æ®</h4>
                                        <p class="text-sm text-white/80">é€‰æ‹©æ ¼å¼å¯¼å‡ºè¯„è®ºæ•°æ®</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- åŠŸèƒ½ç‰¹æ€§ -->
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold text-green-200">âœ¨ åŠŸèƒ½ç‰¹æ€§</h3>
                                <div class="space-y-3">
                                    <div class="bg-green-500/10 border border-green-500/20 rounded-lg p-3">
                                        <h4 class="font-medium text-green-100">ğŸ” æ™ºèƒ½æœç´¢</h4>
                                        <p class="text-sm text-white/80">æ”¯æŒå¤šç§ç­›é€‰æ¡ä»¶å’Œæ’åºæ–¹å¼</p>
                                    </div>
                                    <div class="bg-purple-500/10 border border-purple-500/20 rounded-lg p-3">
                                        <h4 class="font-medium text-purple-100">ğŸ“Š è¯„è®ºåˆ†æ</h4>
                                        <p class="text-sm text-white/80">æƒ…æ„Ÿåˆ†æã€è¯­è¨€æ£€æµ‹ã€æ•°æ®ç»Ÿè®¡</p>
                                    </div>
                                    <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-3">
                                        <h4 class="font-medium text-blue-100">ğŸ“ˆ å†å²è®°å½•</h4>
                                        <p class="text-sm text-white/80">æœç´¢å†å²ã€æµè§ˆè®°å½•ã€æ´»åŠ¨ç»Ÿè®¡</p>
                                    </div>
                                    <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-3">
                                        <h4 class="font-medium text-yellow-100">ğŸ’¾ å¤šæ ¼å¼å¯¼å‡º</h4>
                                        <p class="text-sm text-white/80">JSONã€CSVã€TXTã€HTML æ ¼å¼</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å¸¸è§é—®é¢˜ -->
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold text-yellow-200 mb-3">â“ å¸¸è§é—®é¢˜</h3>
                            <div class="space-y-3">
                                <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-3">
                                    <h4 class="font-medium text-yellow-100">Q: å¦‚ä½•è·å– YouTube API Keyï¼Ÿ</h4>
                                    <p class="text-sm text-white/80">A: è®¿é—® <a href="https://console.developers.google.com/" target="_blank" class="text-blue-300 hover:underline">Google Cloud Console</a>ï¼Œåˆ›å»ºé¡¹ç›®å¹¶å¯ç”¨ YouTube Data API v3ã€‚</p>
                                </div>
                                <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-3">
                                    <h4 class="font-medium text-yellow-100">Q: è¯„è®ºæ•°æ®ä¸ºç©ºæ€ä¹ˆåŠï¼Ÿ</h4>
                                    <p class="text-sm text-white/80">A: è¯·å…ˆç‚¹å‡»"è·å–è¯„è®º"æŒ‰é’®ä¸‹è½½è¯„è®ºæ•°æ®ï¼Œç„¶åå†è¿›è¡Œå¯¼å‡ºæ“ä½œã€‚</p>
                                </div>
                                <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-3">
                                    <h4 class="font-medium text-yellow-100">Q: æ”¯æŒå“ªäº›å¯¼å‡ºæ ¼å¼ï¼Ÿ</h4>
                                    <p class="text-sm text-white/80">A: æ”¯æŒ JSONã€CSVã€TXTã€HTML å››ç§æ ¼å¼ï¼Œæ»¡è¶³ä¸åŒåˆ†æéœ€æ±‚ã€‚</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 text-center">
                            <p class="text-sm text-white/60 mb-4">æ›´å¤šè¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹å„æ ‡ç­¾é¡µå†…çš„ä½¿ç”¨è¯´æ˜</p>
                            <button onclick="this.closest('.fixed').remove()" class="px-6 py-3 bg-blue-500/20 hover:bg-blue-500/30 text-blue-300 rounded-lg transition-all">
                                å…³é—­å¸®åŠ©
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(helpModal);
        }
        
        // Settings
        function showSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            if (apiKey) {
                document.getElementById('apiKey').value = apiKey;
            }
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }
        
        function saveApiKey() {
            console.log('saveApiKey function called'); // è°ƒè¯•ä¿¡æ¯
            const key = document.getElementById('apiKey').value.trim();
            console.log('API key value:', key); // è°ƒè¯•ä¿¡æ¯
            
            if (key) {
                apiKey = key;
                localStorage.setItem('youtube_api_key', key);
                commentManager = new CommentManagerV2(apiKey);
                updateApiStatus(true);
                closeSettings();
                console.log('About to show success notification'); // è°ƒè¯•ä¿¡æ¯
                showNotification('APIå¯†é’¥å·²ä¿å­˜æˆåŠŸï¼', 'success');
                console.log('Success notification should be shown'); // è°ƒè¯•ä¿¡æ¯
            } else {
                console.log('About to show warning notification'); // è°ƒè¯•ä¿¡æ¯
                showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„APIå¯†é’¥', 'warning');
                console.log('Warning notification should be shown'); // è°ƒè¯•ä¿¡æ¯
            }
        }
        
        function updateApiStatus(isConfigured) {
            const indicator = document.getElementById('apiIndicator');
            const status = document.getElementById('apiStatus');
            
            // å®‰å…¨åœ°æ›´æ–°APIçŠ¶æ€ï¼Œæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (indicator && status) {
                if (isConfigured) {
                    indicator.classList.remove('bg-yellow-500');
                    indicator.classList.add('bg-green-500');
                    status.innerHTML = '<div class="w-2 h-2 rounded-full bg-green-500"></div><span class="text-xs">APIå·²é…ç½®</span>';
                } else {
                    indicator.classList.remove('bg-green-500');
                    indicator.classList.add('bg-yellow-500');
                    status.innerHTML = '<div class="w-2 h-2 rounded-full bg-yellow-500"></div><span class="text-xs">APIæœªé…ç½®</span>';
                }
            }
        }
        
        // Data management
        function saveVideos() {
            localStorage.setItem('youtube_videos', JSON.stringify(videos));
            updateStats();
        }
        
        function updateStats() {
            // å®‰å…¨åœ°æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            const totalVideosEl = document.getElementById('totalVideos');
            const totalViewsEl = document.getElementById('totalViews');
            const totalLikesEl = document.getElementById('totalLikes');
            const selectedCountEl = document.getElementById('selectedCount');
            
            if (totalVideosEl) totalVideosEl.textContent = videos.length;
            if (totalViewsEl) totalViewsEl.textContent = formatNumber(
                videos.reduce((sum, v) => sum + (v.views || 0), 0)
            );
            if (totalLikesEl) totalLikesEl.textContent = formatNumber(
                videos.reduce((sum, v) => sum + (v.likes || 0), 0)
            );
            if (selectedCountEl) selectedCountEl.textContent = selectedVideos.size;
        }
        
        function exportVideos() {
            const dataToExport = videos.filter(v => 
                selectedVideos.size === 0 || selectedVideos.has(v.id)
            );
            
            const json = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `youtube-videos-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        
        function clearCache() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜æ•°æ®å—ï¼Ÿ')) {
                localStorage.clear();
                location.reload();
            }
        }
        
        function exportAllData() {
            const allData = {
                videos: videos,
                comments: Array.from(commentManager.comments.entries()),
                history: {
                    search: historyManager.searchHistory,
                    view: historyManager.viewHistory,
                    action: historyManager.actionHistory
                },
                exportDate: new Date().toISOString()
            };
            
            const json = JSON.stringify(allData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `youtube-all-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.videos) {
                            videos = data.videos;
                            saveVideos();
                        }
                        if (data.history) {
                            historyManager.importHistory(data.history);
                        }
                        alert('æ•°æ®å¯¼å…¥æˆåŠŸ');
                        location.reload();
                    } catch (error) {
                        alert('å¯¼å…¥å¤±è´¥: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // Notification system
        function showNotification(message, type = 'info') {
            // ç­‰å¾…DOMåŠ è½½å®Œæˆ
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => showNotification(message, type));
                return;
            }
            
            const container = document.getElementById('notificationContainer');
            if (!container) {
                console.error('Notification container not found, falling back to alert');
                alert(message); // é™çº§åˆ°alert
                return;
            }
            
            const notification = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            notification.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg transform translate-x-full transition-all duration-300`;
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white/80 hover:text-white">
                        âœ•
                    </button>
        </div>
            `;
            
            container.appendChild(notification);
            
            // åŠ¨ç”»è¿›å…¥
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // è‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 4000);
        }
        
        // Utility functions
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }
    </script>
</body>
</html>



